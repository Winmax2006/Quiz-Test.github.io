<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>แบบทดสอบกลางภาค ประวัติศาสตร์ ม.1 – HTML Interactive (40 ข้อ + Reflect)</title>
  <style>
    :root{
      --bg:#0b122a;--panel:#0f1c3a;--card:#1e293b;--ink:#e6f1ff;--muted:#bcd3ff;--accent:#38bdf8;--accent2:#60a5fa;--ok:#22c55e;--warn:#f59e0b;--bad:#ef4444;--bd:#2b3f63
    }
    *{box-sizing:border-box}
    body{margin:0;background:radial-gradient(1200px 800px at 20% -10%,#152247 0%,var(--bg) 50%,#081023 100%);color:var(--ink);font:16px/1.65 system-ui,Inter,"Noto Sans Thai",sans-serif}
    header{position:sticky;top:0;background:rgba(15,28,58,.9);backdrop-filter:blur(10px);border-bottom:1px solid var(--bd);z-index:10}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    h1{margin:8px 0 4px;font-size:clamp(20px,3.5vw,28px)}
    .sub{color:var(--muted);font-size:14px}
    .grid{display:grid;gap:16px}
    @media(min-width:900px){.grid{grid-template-columns:1fr .62fr}}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.01));border:1px solid var(--bd);border-radius:18px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    label{display:block;margin:6px 0;color:var(--muted)}
    input[type=text],input[type=number],textarea{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--bd);background:#0c1834;color:var(--ink)}
    button{appearance:none;border:1px solid var(--bd);background:linear-gradient(180deg,var(--accent2),var(--accent));color:#001326;padding:10px 14px;border-radius:14px;cursor:pointer;font-weight:700}
    button.ghost{background:transparent;color:var(--ink)}
    .toolbar{display:flex;flex-wrap:wrap;gap:8px}
    .item{border:1px solid var(--bd);background:#0f1c3a;border-radius:16px;padding:14px;margin:10px 0}
    .item h3{margin:0 0 8px;font-size:17px}
    .options{display:grid;gap:8px}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border:1px solid var(--bd);border-radius:999px;background:#0d1a37}
    .muted{color:var(--muted)}
    .ok{color:var(--ok)}.bad{color:var(--bad)}
    .progress{height:10px;background:#0e1a35;border-radius:999px;overflow:hidden;border:1px solid var(--bd)}
    .bar{height:100%;background:linear-gradient(90deg,var(--accent2),var(--accent));width:0}
    .kpa{display:flex;gap:8px;flex-wrap:wrap}
    .tag{padding:4px 8px;border-radius:999px;border:1px solid var(--bd);font-size:12px;background:#0e1b39}
    .legend{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}

    /* Drag & Drop */
    .dnd-zone{display:grid;gap:10px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .left,.right{border:1px dashed var(--bd);border-radius:12px;padding:10px;min-height:48px}
    .draggable{display:inline-block;border:1px solid var(--bd);background:#13244a;padding:6px 10px;border-radius:10px;margin:6px 6px 0 0;cursor:grab}
    .drop{min-height:44px;border:1px dashed var(--bd);border-radius:10px;padding:8px}
    .drop.highlight{outline:2px solid var(--accent)}
    .order-list{list-style:none;margin:0;padding:0}
    .order-item{border:1px solid var(--bd);background:#15264e;margin:6px 0;padding:8px;border-radius:10px;cursor:grab}

    .result{white-space:pre-wrap;background:#0b1938;border:1px solid var(--bd);padding:12px;border-radius:12px}
    .foot{color:var(--muted);font-size:12px;margin-top:16px}
    .hidden{display:none}

    /* self sliders */
    .slider-row{display:grid;grid-template-columns:140px 1fr 60px;gap:10px;align-items:center}
    input[type=range]{width:100%}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>แบบทดสอบกลางภาค ประวัติศาสตร์ ม.1 (40 ข้อ + Reflect)</h1>
      <div class="sub">ม.1/1 วิธีการทางประวัติศาสตร์ · ม.1/2 แผนที่–ไทม์ไลน์–หลักฐาน · K–P–A + Self & GAP → ส่งออก Google Sheets</div>
    </div>
  </header>

  <main class="wrap grid">
    <section class="card">
      <h2>ข้อมูลผู้สอบ</h2>
      <div class="grid" style="grid-template-columns:1fr 1fr">
        <div>
          <label>ชื่อ–สกุล</label>
          <input id="st_name" type="text" placeholder="กรอกชื่อ–สกุล" />
        </div>
        <div>
          <label>รหัสนักเรียน</label>
          <input id="st_id" type="text" placeholder="เช่น S0123" />
        </div>
        <div>
          <label>ห้อง/เลขที่</label>
          <input id="st_class" type="text" placeholder="ม.1/x เลขที่ y" />
        </div>
        <div>
          <label>รหัสข้อสอบ (ถ้ามี)</label>
          <input id="test_code" type="text" placeholder="เช่น MT-HIS-01" />
        </div>
      </div>
      <div class="legend">
        <span class="tag">K ความรู้</span>
        <span class="tag">P กระบวนการ</span>
        <span class="tag">A เจตคติ</span>
        <span class="tag">Self K–P–A</span>
        <span class="tag">ม.1/1 · ม.1/2</span>
        <span class="tag">บริบท: สระบุรี & อยุธยา</span>
      </div>
      <div class="toolbar" style="margin-top:12px">
        <button id="btnSave" class="ghost">บันทึกชั่วคราว</button>
        <button id="btnLoad" class="ghost">กู้คืน</button>
        <button id="btnReset" class="ghost">ล้างคำตอบ</button>
        <button id="btnCSV">Export CSV</button>
        <button id="btnJSON">Export JSON</button>
        <button id="btnSheets">ส่งไป Google Sheets</button>
      </div>
      <div style="margin-top:12px">
        <div class="progress"><div class="bar" id="progBar"></div></div>
        <div class="sub" id="progText">ความคืบหน้า 0/40</div>
      </div>
    </section>

    <section class="card">
      <h2>สรุปผล</h2>
      <div id="scoreSummary" class="result muted">ยังไม่มีผลลัพธ์ กด "ตรวจคำตอบ" เพื่อประมวลผล</div>
      <div class="toolbar" style="margin-top:8px">
        <button id="btnSubmit">ตรวจคำตอบ</button>
        <button id="btnShowDetail" class="ghost">แสดงผลรายข้อ</button>
      </div>
      <div id="detail" class="result hidden" style="margin-top:8px"></div>
      <div class="foot">ระบบบันทึกอัตโนมัติ และสามารถส่งออกผลไปยัง Google Sheets</div>
    </section>
  </main>

  <section class="wrap card" id="selfSection">
    <h2>Self-Assessment (K–P–A) & Reflection</h2>
    <div class="slider-row"><div>K (ความรู้)</div><input id="selfK" type="range" min="1" max="5" step="1" value="3"/><div><span id="selfKVal">3</span>/5</div></div>
    <div class="slider-row"><div>P (กระบวนการ)</div><input id="selfP" type="range" min="1" max="5" step="1" value="3"/><div><span id="selfPVal">3</span>/5</div></div>
    <div class="slider-row"><div>A (ทัศนคติ)</div><input id="selfA" type="range" min="1" max="5" step="1" value="3"/><div><span id="selfAVal">3</span>/5</div></div>
    <label>Reflection (ย่อ 2–3 บรรทัด): อะไรที่ทำได้ดี? อะไรที่ยังงง? จะพัฒนาต่ออย่างไร?</label>
    <textarea id="reflectText" rows="4" placeholder="พิมพ์สะท้อนผลการเรียนรู้ของคุณ..."></textarea>
    <div class="foot">หมายเหตุ: Self จะใช้วิเคราะห์ GAP และ Progression Level (Observed vs Self)</div>
  </section>

  <section class="wrap card" id="itemsSection">
    <h2>ข้อสอบ (40 ข้อ)</h2>
    <div id="items"></div>
  </section>

<script>
/*********************************
 * CONFIG สำหรับส่งออกไป Google Sheets (Apps Script Web App)
 *********************************/
const CONFIG = {
  SHEETS_WEBAPP_URL: "https://script.google.com/macros/s/AKfycbwP441pymXV-I6TkCN-wLsR9-gin5_pjzU8L8wqJdJosvxfJ-5EuaSVkUdoBmWXNIBi/exec",
};

/*********************************
 * โครงสร้างข้อมูลข้อสอบ (40 ข้อ)
 * type: mcq | short | match | order | classify
 *********************************/
const ITEMS = [
  // 1–14 MCQ
  {id:1, type:'mcq', indicator:'ม.1/1', kpa:'K', dok:1,
    prompt:'ข้อใดคือความหมายของ “ประวัติศาสตร์” ได้ใกล้เคียงที่สุด',
    options:['เรื่องเล่าความเป็นมาของบุคคลสำคัญ','การศึกษาความเป็นมาของมนุษย์จากหลักฐานและการตีความอย่างมีระบบ','เหตุการณ์ในอดีตที่เล่าสืบต่อกันมา','ตำนาน นิทานพื้นบ้าน'], answer:1},
  {id:2, type:'mcq', indicator:'ม.1/1', kpa:'K', dok:1,
    prompt:'หลักฐานประเภทใดจัดเป็น “หลักฐานปฐมภูมิ”',
    options:['ตำราเรียน','บทความสรุปเหตุการณ์','ศิลาจารึกสุโขทัย','บทวิเคราะห์ทางทีวี'], answer:2},
  {id:3, type:'mcq', indicator:'ม.1/1', kpa:'K', dok:1,
    prompt:'ต่อไปนี้ข้อใด “ไม่นับเป็น” หลักฐานทางประวัติศาสตร์',
    options:['โบราณวัตถุ','พยานบุคคล','ความเชื่อส่วนตัวที่ไม่มีหลักฐาน','จดหมายเหตุ'], answer:2},
  {id:4, type:'mcq', indicator:'ม.1/1', kpa:'P', dok:2,
    prompt:'ข้อใดเป็น “ขั้นตอนแรก” ของวิธีการทางประวัติศาสตร์',
    options:['ตีความหลักฐาน','ตั้งคำถาม/กำหนดปัญหา','สังเคราะห์และเขียนรายงาน','วิพากษ์/ตรวจสอบหลักฐาน'], answer:1},
  {id:5, type:'mcq', indicator:'ม.1/1', kpa:'P', dok:2,
    prompt:'คำถามใด “เหมาะ” กับการสืบค้นเชิงประวัติศาสตร์มากที่สุด',
    options:['อาหารอะไรอร่อยที่สุดในโรงอาหาร?','เหตุใดรัฐสุโขทัยจึงเกิดขึ้นได้ในศตวรรษที่ 13?','นักเรียนชอบวิชาไหนมากที่สุด?','ถ่ายรูปที่สวยที่สุดคือแบบใด?'], answer:1},
  {id:6, type:'mcq', indicator:'ม.1/1', kpa:'P', dok:2,
    prompt:'ข้อใดแสดงการอธิบายแบบ “เหตุและผล” ได้ถูกต้อง',
    options:['อยุธยาล่มเพราะถึงกำหนดเวลา','เพราะผู้คนเบื่อสงคราม','เพราะเกิดภัยธรรมชาติทุกปี','เพราะถูกโจมตีซ้ำๆ จนเมืองแตกใน พ.ศ.2310'], answer:3},
  {id:7, type:'mcq', indicator:'ม.1/2', kpa:'K', dok:1,
    prompt:'สัญลักษณ์ “ลูกศรยาวบนแผนที่” โดยทั่วไปสื่อความหมายใด',
    options:['เส้นชั้นความสูง','ทิศทางการเคลื่อนที่/การไหล','เขตแดนจังหวัด','ตำแหน่งเมืองหลวง'], answer:1},
  {id:8, type:'mcq', indicator:'ม.1/2', kpa:'K', dok:1,
    prompt:'มาตราส่วนแผนที่ใดแสดงรายละเอียดได้ “มากกว่า”',
    options:['1:5,000','1:50,000','1:500,000','1:5,000,000'], answer:0},
  {id:9, type:'mcq', indicator:'ม.1/2', kpa:'K', dok:1,
    prompt:'กรุงเทพมหานครอยู่ในซีกโลกใด',
    options:['เหนือและตะวันตก','เหนือและตะวันออก','ใต้และตะวันตก','ใต้และตะวันออก'], answer:1},
  {id:10, type:'mcq', indicator:'ม.1/2', kpa:'P', dok:2,
    prompt:'ลำดับเหตุการณ์ใดถูกต้องจาก “เก่าสุด → ใหม่สุด”',
    options:['ตั้งกรุงรัตนโกสินทร์ → สุโขทัย → อยุธยา','สุโขทัย → อยุธยา → กรุงธนบุรี','อยุธยา → สุโขทัย → กรุงธนบุรี','สุโขทัย → กรุงธนบุรี → อยุธยา'], answer:1},
  {id:11, type:'mcq', indicator:'ม.1/2', kpa:'P', dok:2,
    prompt:'หลักฐานใด “เหมาะที่สุด” เพื่ออธิบายการอพยพของชนชาติไทจากตอนใต้ของจีน',
    options:['ภาพยนตร์ประวัติศาสตร์','จดหมายเหตุจีน/บันทึกเดินทางโบราณ','นิทานปรัมปรา','บทความความคิดเห็นในสื่อสังคม'], answer:1},
  {id:12, type:'mcq', indicator:'ม.1/2', kpa:'K', dok:1,
    prompt:'แม่น้ำใดไหลผ่านประเทศไทย',
    options:['เจ้าพระยา','โขง','สาละวิน','ถูกทุกข้อ'], answer:3},
  {id:13, type:'mcq', indicator:'ม.1/1', kpa:'A', dok:2,
    prompt:'ข้อใด “แสดงท่าทีที่เป็นกลาง” ต่อหลักฐานได้ดีกว่า',
    options:['เลือกหลักฐานที่สนับสนุนความเชื่อของตนเท่านั้น','ตรวจสอบที่มา เปรียบเทียบหลายแหล่งก่อนสรุป','เชื่อสิ่งที่เพื่อนเล่ามาเพราะไว้ใจ','ปฏิเสธหลักฐานที่ขัดความเชื่อเสมอ'], answer:1},
  {id:14, type:'mcq', indicator:'ม.1/1', kpa:'A', dok:2,
    prompt:'แนวทางใดช่วยลด “อคติ” เมื่อวิเคราะห์เหตุการณ์ประวัติศาสตร์',
    options:['ใช้แหล่งเดียวที่เชื่อถือได้','เปิดรับมุมมองต่างกันและให้เหตุผลบนหลักฐาน','เชื่อเสียงส่วนใหญ่เสมอ','ยึดความเห็นของผู้มีอำนาจ'], answer:1},

  // 15–20 SHORT ANSWER
  {id:15, type:'short', indicator:'ม.1/1', kpa:'K', dok:2,
    prompt:'อธิบายสั้น ๆ ความต่างระหว่าง “หลักฐานปฐมภูมิ” กับ “ทุติยภูมิ” (อย่างละ 1 ตัวอย่าง) — ตอบเป็นคำ/วลีไทย',
    shortConf:{mode:'keywords', minAny:2, any:['ปฐม','ทุติ','ศิลาจารึก','จดหมายเหตุ','พงศาวดาร','ตำรา','บทความ','โบราณวัตถุ']}},
  {id:16, type:'short', indicator:'ม.1/1', kpa:'P', dok:2,
    prompt:'เหตุการณ์ “การสถาปนาสุโขทัย” ให้ระบุ “สาเหตุ” หรือ “ผล” อย่างน้อย 1 ประการ',
    shortConf:{mode:'keywords', minAny:1, any:['อพยพ','จีนใต้','ชุมชนไท','ความมั่นคง','การปกครอง','การค้าขาย','อิทธิพลขอม']}},
  {id:17, type:'short', indicator:'ม.1/2', kpa:'K', dok:1,
    prompt:'เชียงใหม่อยู่ทิศใดของกรุงเทพฯ (ตอบย่อ: N/NE/E/SE/S/SW/W/NW หรือ ทิศเหนือ/ตะวันออกเฉียงเหนือ ฯลฯ)',
    shortConf:{mode:'enum', any:['NW','WNW','เหนือทางตะวันตก','ตะวันตกเฉียงเหนือ','ทิศตะวันตกเฉียงเหนือ']}},
  {id:18, type:'short', indicator:'ม.1/2', kpa:'P', dok:1,
    prompt:'ระบุ “ปีที่เก่าที่สุด” ในชุดต่อไปนี้: 1350, 1238, 1767 (ตอบเป็นตัวเลข 4 หลัก)',
    shortConf:{mode:'number', exact:1238}},
  {id:19, type:'short', indicator:'ม.1/2', kpa:'P', dok:2,
    prompt:'มาตราส่วน 1:50,000 ระยะบนแผนที่ 3 ซม. เท่ากับกี่กม.? (ตอบเป็นตัวเลข เช่น 1.5)',
    shortConf:{mode:'number', exact:1.5, tol:0.05}},
  {id:20, type:'short', indicator:'ม.1/2', kpa:'P', dok:2,
    prompt:'ยกตัวอย่างหลักฐาน 1 ชิ้น ที่ใช้ศึกษาการค้าต่างชาติสมัยอยุธยา (คำหลักเช่น จดหมายเหตุ/บันทึก/แผนที่การเดินเรือ/ซากเรือ/ลา ลูแบร์)',
    shortConf:{mode:'keywords', minAny:1, any:['จดหมายเหตุ','พงศาวดาร','แผนที่','เรือ','ลา ลูแบร์','La Loubère','บันทึกเดินเรือ','ตราประทับการค้า']}},

  // 21–25 MATCH (จับคู่)
  {id:21, type:'match', indicator:'ม.1/1', kpa:'K', dok:2,
    prompt:'จับคู่ “หลักฐาน” กับ “ประเภท” ให้ถูกต้อง',
    pairs:[
      {left:'ศิลาจารึกสุโขทัย', right:'ปฐมภูมิ'},
      {left:'ตำราเรียนประวัติศาสตร์', right:'ทุติยภูมิ'},
      {left:'แผนที่ร่วมสมัยของยุคนั้น', right:'ปฐมภูมิ'},
      {left:'บทความสรุปเหตุการณ์', right:'ทุติยภูมิ'}
    ]},
  {id:22, type:'match', indicator:'ม.1/1', kpa:'P', dok:2,
    prompt:'จับคู่ “ขั้นตอนวิธีการทางประวัติศาสตร์” กับ “คำอธิบาย”',
    pairs:[
      {left:'ตั้งคำถาม', right:'กำหนดประเด็น/ปัญหา'},
      {left:'รวบรวมหลักฐาน', right:'ค้นหาแหล่งข้อมูล'},
      {left:'วิพากษ์หลักฐาน', right:'ตรวจสอบที่มา/ความน่าเชื่อถือ'},
      {left:'ตีความ/สังเคราะห์', right:'อธิบายและสรุปผล'}
    ]},
  {id:23, type:'match', indicator:'ม.1/2', kpa:'K', dok:1,
    prompt:'จับคู่ “องค์ประกอบแผนที่” กับ “หน้าที่”',
    pairs:[
      {left:'มาตราส่วน', right:'แปลงระยะทางจริง'},
      {left:'สัญลักษณ์', right:'สื่อความหมายข้อมูล'},
      {left:'ทิศ', right:'บอกการวางตำแหน่ง'},
      {left:'คำอธิบายแผนที่ (legend)', right:'ไขความหมายสัญลักษณ์'}
    ]},
  {id:24, type:'match', indicator:'ม.1/2', kpa:'P', dok:2,
    prompt:'จับคู่ “เหตุการณ์” กับ “ช่วงเวลา/คำอธิบายโดยย่อ”',
    pairs:[
      {left:'สถาปนาสุโขทัย', right:'ศตวรรษที่ 13 (พ.ศ. 1780s–)'},
      {left:'ตั้งกรุงศรีอยุธยา', right:'พ.ศ. 1893 (ค.ศ. 1350)'},
      {left:'กรุงธนบุรี', right:'หลังเสียกรุง พ.ศ. 2310'},
      {left:'ตั้งกรุงรัตนโกสินทร์', right:'พ.ศ. 2325'}
    ]},
  {id:25, type:'match', indicator:'ม.1/2', kpa:'K', dok:1,
    prompt:'จับคู่ “เมือง” กับ “ภูมิภาคของไทย”',
    pairs:[
      {left:'เชียงใหม่', right:'ภาคเหนือ'},
      {left:'ขอนแก่น', right:'ภาคตะวันออกเฉียงเหนือ'},
      {left:'ภูเก็ต', right:'ภาคใต้'},
      {left:'พระนครศรีอยุธยา', right:'ภาคกลาง'}
    ]},

  // 26–30 DnD
  {id:26, type:'order', indicator:'ม.1/2', kpa:'P', dok:2,
    prompt:'ลาก–เรียงลำดับ “เก่าสุด → ใหม่สุด”',
    order:['ก่อนประวัติศาสตร์','ทวารวดี','สุโขทัย','อยุธยา']},

  {id:27, type:'order', indicator:'ม.1/1', kpa:'P', dok:2,
    prompt:'เรียงลำดับ “ขั้นตอนวิธีการทางประวัติศาสตร์” อย่างมีเหตุผล',
    order:['ตั้งคำถาม','รวบรวมหลักฐาน','วิพากษ์หลักฐาน','ตีความ/สังเคราะห์']},

  {id:28, type:'classify', indicator:'ม.1/1', kpa:'K', dok:2,
    prompt:'จัดหมวด “หลักฐาน” ลงกล่อง ปฐมภูมิ/ทุติยภูมิ',
    categories:['ปฐมภูมิ','ทุติยภูมิ'],
    items:[
      {text:'ศิลาจารึก', cat:'ปฐมภูมิ'},
      {text:'บันทึกเดินเรือร่วมสมัย', cat:'ปฐมภูมิ'},
      {text:'บทความวิเคราะห์สมัยใหม่', cat:'ทุติยภูมิ'},
      {text:'ตำราเรียน', cat:'ทุติยภูมิ'}
    ]},

  {id:29, type:'classify', indicator:'ม.1/2', kpa:'P', dok:2,
    prompt:'จัดหมวด “ทิศทางจากกรุงเทพฯ” ของเมืองต่าง ๆ (ลากชื่อเมืองลงกล่องทิศที่ถูกต้อง)',
    categories:['ทิศเหนือ/ตะวันตกเฉียงเหนือ','ทิศตะวันออกเฉียงเหนือ','ทิศตะวันออก/ตะวันออกเฉียงใต้','ทิศใต้/ตะวันตกเฉียงใต้','ทิศตะวันตก/ตะวันตกเฉียงใต้'],
    items:[
      {text:'เชียงใหม่', cat:'ทิศเหนือ/ตะวันตกเฉียงเหนือ'},
      {text:'นครราชสีมา (โคราช)', cat:'ทิศตะวันออกเฉียงเหนือ'},
      {text:'ชลบุรี', cat:'ทิศตะวันออก/ตะวันออกเฉียงใต้'},
      {text:'หัวหิน/ประจวบฯ', cat:'ทิศตะวันตก/ตะวันตกเฉียงใต้'},
      {text:'ภูเก็ต', cat:'ทิศใต้/ตะวันตกเฉียงใต้'}
    ]},

  {id:30, type:'classify', indicator:'ม.1/2', kpa:'P', dok:3,
    prompt:'ลาก “หลักฐานการค้าต่างชาติสมัยอยุธยา” ลงกล่องตาม “ความหนักแน่นของหลักฐาน”',
    categories:['หนักแน่นมาก','พอใช้','อ่อนแอ'],
    items:[
      {text:'จดหมายเหตุ ลา ลูแบร์', cat:'หนักแน่นมาก'},
      {text:'ซากเรือโบราณพบในอ่าวไทย', cat:'หนักแน่นมาก'},
      {text:'แผนที่การเดินเรือร่วมสมัย', cat:'พอใช้'},
      {text:'ภาพวาดสมัยหลังจากจินตนาการ', cat:'อ่อนแอ'}
    ]},

  // 31–36 บริบทเฉพาะ: สระบุรี & อยุธยา
  {id:31, type:'mcq', indicator:'ม.1/2', kpa:'K', dok:1,
    prompt:'พระนครศรีอยุธยาอยู่ทิศใดของสระบุรี โดยประมาณ?',
    options:['เหนือ','ใต้','ตะวันตก','ตะวันออกเฉียงใต้'], answer:3},
  {id:32, type:'short', indicator:'ม.1/2', kpa:'P', dok:2,
    prompt:'บนแผนที่มาตราส่วน 1:250,000 หากระยะระหว่างสระบุรี–อยุธยา ยาว 2 ซม. ระยะจริงประมาณกี่กิโลเมตร?',
    shortConf:{mode:'number', exact:50, tol:5}},
  {id:33, type:'match', indicator:'ม.1/2', kpa:'P', dok:2,
    prompt:'จับคู่ “แหล่งน้ำ/เส้นทาง” กับ “บทบาททางประวัติศาสตร์ท้องถิ่น (สระบุรี–อยุธยา)”',
    pairs:[
      {left:'แม่น้ำป่าสัก', right:'เส้นทางคมนาคม/เกษตร'},
      {left:'เจ้าพระยา (ตอนอยุธยา)', right:'ศูนย์กลางการค้า/คมนาคมหลัก'},
      {left:'ทิวเขาดงพญาเย็น', right:'แนวภูมิประเทศสำคัญของภาคกลางตอนบน'},
      {left:'คลองชลประทาน', right:'ระบบจัดการน้ำยุคใหม่'}
    ]},
  {id:34, type:'order', indicator:'ม.1/2', kpa:'P', dok:2,
    prompt:'เรียงลำดับเส้นทาง “สระบุรี → พระนครศรีอยุธยา → กรุงเทพฯ” จากเหนือไปใต้',
    order:['สระบุรี','พระนครศรีอยุธยา','กรุงเทพฯ']},
  {id:35, type:'mcq', indicator:'ม.1/2', kpa:'P', dok:2,
    prompt:'ถ้าต้องอธิบายบทบาทของอยุธยาในเครือข่ายการค้าลุ่มน้ำเจ้าพระยา หลักฐานใด "เหมาะสมที่สุด"',
    options:['ภาพวาดร่วมสมัย','จดหมายเหตุฝรั่ง/แผนที่เดินเรือ','นิทานพื้นบ้าน','บันทึกโพสต์สมัยใหม่'], answer:1},
  {id:36, type:'short', indicator:'ม.1/2', kpa:'K', dok:1,
    prompt:'ระบุภูมิภาคของ “สระบุรี” และ “พระนครศรีอยุธยา” (ตอบสั้น ๆ เช่น ภาคกลาง)',
    shortConf:{mode:'keywords', minAny:1, any:['ภาคกลาง','ภาค กลาง','central']}},

  // 37–40 REFLECT
  {id:37, type:'short', indicator:'Reflect', kpa:'A', dok:2,
    prompt:'Reflect-1: สิ่งที่ฉันทำได้ดีในการใช้แผนที่/ไทม์ไลน์ คือ...',
    shortConf:{mode:'keywords', minAny:1, any:['แผนที่','ไทม์ไลน์','หลักฐาน','เหตุผล','ตรวจสอบ']}},
  {id:38, type:'short', indicator:'Reflect', kpa:'P', dok:2,
    prompt:'Reflect-2: ขั้นตอนวิธีการทางประวัติศาสตร์ที่ฉันควรฝึกเพิ่ม คือ...',
    shortConf:{mode:'keywords', minAny:1, any:['ตั้งคำถาม','รวบรวม','วิพากษ์','ตีความ','สังเคราะห์']}},
  {id:39, type:'short', indicator:'Reflect', kpa:'A', dok:2,
    prompt:'Reflect-3: ฉันจะแก้อคติ/มองหลายมุมมองอย่างไรในการศึกษาเหตุการณ์ในท้องถิ่น (สระบุรี–อยุธยา)',
    shortConf:{mode:'keywords', minAny:1, any:['อคติ','หลายมุมมอง','เปรียบเทียบ','แหล่งข้อมูล','หลักฐาน']}},
  {id:40, type:'short', indicator:'Reflect', kpa:'P', dok:2,
    prompt:'Reflect-4: แผนต่อไปฉันจะทดลอง “วิธีการ” ใดเพื่ออธิบายเหตุการณ์ท้องถิ่นได้ดีขึ้น?',
    shortConf:{mode:'keywords', minAny:1, any:['แผนที่','ไทม์ไลน์','จดหมายเหตุ','สัมภาษณ์','แผนผัง','สืบค้น']}}
];

/******************* ยูทิลิตี้ *******************/
const $ = (sel,par=document)=>par.querySelector(sel);
const $$ = (sel,par=document)=>Array.from(par.querySelectorAll(sel));

function saveToLocal(){
  const key = 'HIS_M1_MT_' + ($('#test_code').value||'DEFAULT');
  const data = {
    name:$('#st_name').value,id:$('#st_id').value,cls:$('#st_class').value,code:$('#test_code').value,
    self:{K:val('#selfK'),P:val('#selfP'),A:val('#selfA'),ref:$('#reflectText').value},
    answers: collectAnswers(), timestamp: Date.now()
  };
  localStorage.setItem(key, JSON.stringify(data));
}
function loadFromLocal(){
  const key = 'HIS_M1_MT_' + ($('#test_code').value||'DEFAULT');
  const raw = localStorage.getItem(key);
  if(!raw) return alert('ไม่พบข้อมูลบันทึก');
  const data = JSON.parse(raw);
  $('#st_name').value=data.name||'';
  $('#st_id').value=data.id||'';
  $('#st_class').value=data.cls||'';
  $('#test_code').value=data.code||$('#test_code').value;
  if(data.self){ $('#selfK').value=data.self.K||3; $('#selfP').value=data.self.P||3; $('#selfA').value=data.self.A||3; $('#reflectText').value=data.self.ref||''; syncSelfVals(); }
  render();
  restoreAnswers(data.answers||{});
}

/******************* เรนเดอร์ข้อสอบ *******************/
const container = $('#items');

function render(){
  container.innerHTML='';
  for(const it of ITEMS){
    const card = document.createElement('div');
    card.className='item';
    const meta = `<div class="kpa"><span class="tag">${it.indicator}</span><span class="tag">${it.kpa}</span><span class="tag">DOK ${it.dok}</span><span class="tag">${typeLabel(it.type)}</span></div>`;
    card.innerHTML = `<h3>ข้อ ${it.id}. ${escapeHtml(it.prompt)}</h3>${meta}<div class="body"></div>`;
    const body = $('.body', card);
    if(it.type==='mcq') renderMCQ(it, body);
    if(it.type==='short') renderShort(it, body);
    if(it.type==='match') renderMatch(it, body);
    if(it.type==='order') renderOrder(it, body);
    if(it.type==='classify') renderClassify(it, body);
    container.appendChild(card);
  }
  updateProgress();
}

function typeLabel(t){ return {mcq:'ตัวเลือก', short:'คำตอบสั้น', match:'จับคู่', order:'เรียงลำดับ', classify:'จัดหมวด'}[t]||t; }
function escapeHtml(s){return s.replace(/[&<>]/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[c]))}

function renderMCQ(it, el){
  const box = document.createElement('div'); box.className='options';
  it.options.forEach((op,idx)=>{ const row = document.createElement('label'); row.className='pill'; row.innerHTML = `<input type="radio" name="q${it.id}" value="${idx}" /> ${escapeHtml(op)}`; box.appendChild(row); });
  el.appendChild(box);
}
function renderShort(it, el){ const inp = document.createElement('input'); inp.type='text'; inp.placeholder='พิมพ์คำตอบสั้น ๆ'; inp.name = 'q'+it.id; el.appendChild(inp); }
function renderMatch(it, el){
  const wrap = document.createElement('div'); wrap.className='row';
  const left = document.createElement('div'); left.className='left';
  const right = document.createElement('div'); right.className='right';
  left.dataset.itemId = it.id; right.dataset.itemId = it.id;
  it.pairs.forEach(p=>{ const d = document.createElement('span'); d.className='draggable'; d.textContent=p.left; d.draggable=true; d.dataset.key=p.left; d.dataset.type='drag'; d.dataset.itemId=it.id; left.appendChild(d); });
  it.pairs.forEach(p=>{ const dz = document.createElement('div'); dz.className='drop'; dz.dataset.target=p.right; dz.dataset.itemId=it.id; dz.textContent=p.right; right.appendChild(dz); });
  wrap.appendChild(left); wrap.appendChild(right); el.appendChild(wrap);
}
function renderOrder(it, el){ const ul = document.createElement('ul'); ul.className='order-list'; it.order.forEach(txt=>{ const li=document.createElement('li'); li.className='order-item'; li.textContent=txt; li.draggable=true; li.dataset.itemId=it.id; ul.appendChild(li); }); el.appendChild(ul); }
function renderClassify(it, el){
  const wrap = document.createElement('div'); wrap.className='dnd-zone';
  const pool = document.createElement('div'); pool.className='left'; pool.dataset.itemId=it.id;
  it.items.forEach(obj=>{ const d=document.createElement('span'); d.className='draggable'; d.textContent=obj.text; d.draggable=true; d.dataset.cat=obj.cat; d.dataset.itemId=it.id; pool.appendChild(d); });
  const zones = document.createElement('div'); zones.className='row';
  it.categories.forEach(cat=>{ const dz=document.createElement('div'); dz.className='drop'; dz.dataset.category=cat; dz.dataset.itemId=it.id; dz.innerHTML = `<strong>${cat}</strong>`; zones.appendChild(dz); });
  wrap.appendChild(pool); wrap.appendChild(zones); el.appendChild(wrap);
}

/******************* Drag & Drop *******************/
let dragEl = null; let draggedOrder=null;
document.addEventListener('dragstart', e=>{ const t=e.target; if(t.classList.contains('draggable')){ dragEl=t; e.dataTransfer.setData('text/plain', t.textContent); } if(t.classList.contains('order-item')){ draggedOrder=t; } });
document.addEventListener('dragover', e=>{ if(e.target.classList && e.target.classList.contains('drop')){ e.preventDefault(); e.target.classList.add('highlight'); } if(e.target.classList && e.target.classList.contains('order-item')) e.preventDefault(); });
document.addEventListener('dragleave', e=>{ if(e.target.classList && e.target.classList.contains('drop')) e.target.classList.remove('highlight'); });
document.addEventListener('drop', e=>{ const dz=e.target.closest('.drop'); if(dz){ e.preventDefault(); dz.classList.remove('highlight'); if(!dragEl) return; if(dz.dataset.itemId!==dragEl.dataset.itemId) return; dz.appendChild(dragEl); dragEl=null; updateProgress(); saveToLocal(); return; } if(e.target.classList && e.target.classList.contains('order-item')){ e.preventDefault(); const parent=e.target.parentNode; const rect=e.target.getBoundingClientRect(); const before=(e.clientY-rect.top) < rect.height/2; parent.insertBefore(draggedOrder, before? e.target : e.target.nextSibling); updateProgress(); saveToLocal(); }});

/******************* เก็บ/คืนคำตอบ *******************/
function collectAnswers(){
  const ans={};
  ITEMS.forEach(it=>{
    if(it.type==='mcq'){ const val = $$(`input[name=q${it.id}]:checked`).map(i=>i.value)[0]; if(val!==undefined) ans[it.id]=val; }
    if(it.type==='short'){ const val = $(`input[name=q${it.id}]`)?.value||''; if(val.trim()) ans[it.id]=val.trim(); }
    if(it.type==='match'){ const pairs={}; $$(`.drop[data-item-id="${it.id}"]`).forEach(dz=>{ const left=$('span.draggable',dz); if(left) pairs[dz.dataset.target]=left.textContent; }); ans[it.id]=pairs; }
    if(it.type==='order'){ const seq=[]; $$(`.order-list .order-item[data-item-id="${it.id}"]`).forEach(li=>seq.push(li.textContent)); ans[it.id]=seq; }
    if(it.type==='classify'){ const cls={}; $$(`.drop[data-item-id="${it.id}"]`).forEach(dz=>{ const arr=$$('span.draggable',dz).map(x=>x.textContent); cls[dz.dataset.category]=arr; }); ans[it.id]=cls; }
  });
  return ans;
}
function restoreAnswers(ans){
  ITEMS.forEach(it=>{
    if(it.type==='mcq' && ans[it.id]!==undefined){ const rb = $(`input[name=q${it.id}][value="${ans[it.id]}"]`); if(rb){ rb.checked=true; } }
    if(it.type==='short' && ans[it.id]!==undefined){ const ip = $(`input[name=q${it.id}]`); if(ip){ ip.value=ans[it.id]; } }
    if(it.type==='match' && typeof ans[it.id]==='object'){
      Object.entries(ans[it.id]).forEach(([right,leftTxt])=>{ const dz = $(`.drop[data-item-id="${it.id}"][data-target="${cssEscape(right)}"]`); const src = Array.from($$(`.left[data-item-id="${it.id}"] .draggable`)).find(x=>x.textContent===leftTxt); if(dz && src){ dz.appendChild(src); } });
    }
    if(it.type==='order' && Array.isArray(ans[it.id])){
      const ul = $(`.order-list .order-item[data-item-id="${it.id}"]`)?.parentElement; if(ul){ const all = Array.from($$(`.order-list .order-item[data-item-id="${it.id}"]`)); ans[it.id].forEach(txt=>{ const li = all.find(x=>x.textContent===txt); if(li) ul.appendChild(li); }); }
    }
    if(it.type==='classify' && typeof ans[it.id]==='object'){
      Object.entries(ans[it.id]).forEach(([cat,arr])=>{ const dz = $(`.drop[data-item-id="${it.id}"][data-category="${cssEscape(cat)}"]`); if(dz) arr.forEach(txt=>{ const src = Array.from($$(`.left[data-item-id="${it.id}"] .draggable, .drop[data-item-id="${it.id}"] .draggable`)).find(x=>x.textContent===txt); if(src) dz.appendChild(src); }); });
    }
  });
  updateProgress();
}

function cssEscape(s){return s.replace(/"/g,'\\"')}
function val(q){return Number($(q)?.value||0)}
function syncSelfVals(){ $('#selfKVal').textContent=val('#selfK'); $('#selfPVal').textContent=val('#selfP'); $('#selfAVal').textContent=val('#selfA'); }

/******************* การตรวจคำตอบ + GAP + LEVEL *******************/
function evaluate(){
  const ans = collectAnswers();
  const detail=[]; let total=0; const max=ITEMS.length; let K=0,P=0,A=0; let I11=0,I12=0;

  function addScore(it,score,maxUnit=1){ total+=score; if(it.kpa==='K') K+=score; else if(it.kpa==='P') P+=score; else if(it.kpa==='A') A+=score; if(it.indicator==='ม.1/1') I11+=score; else if(it.indicator==='ม.1/2') I12+=score; detail.push({id:it.id,type:it.type,score,max:maxUnit,indicator:it.indicator,kpa:it.kpa}); }

  for(const it of ITEMS){
    const a = ans[it.id]; if(a===undefined){ addScore(it,0); continue; }
    if(it.type==='mcq'){ addScore(it, Number(a)==it.answer?1:0); }
    if(it.type==='short'){
      const conf = it.shortConf||{}; let ok=0;
      if(conf.mode==='number'){ const v=parseFloat((a+'').replace(/,/g,'')); if(!isNaN(v)){ const tol=conf.tol??0; ok=(Math.abs(v-(conf.exact))<=tol)?1:0; } }
      else if(conf.mode==='enum'){ const norm=(a+'').trim().toUpperCase(); ok=(conf.any||[]).map(x=>x.toUpperCase()).some(x=>norm.includes(x))?1:0; }
      else if(conf.mode==='keywords'){ const s=(a+'').toLowerCase(); let cnt=0; (conf.any||[]).forEach(k=>{ if(s.includes(k.toLowerCase())) cnt++; }); ok = cnt >= (conf.minAny||1) ? 1:0; }
      else { ok = a.toString().trim()?1:0; }
      addScore(it, ok);
    }
    if(it.type==='match'){ let m=it.pairs.length, sc=0; it.pairs.forEach(p=>{ if(a[p.right]===p.left) sc++; }); addScore(it, sc/m, 1); }
    if(it.type==='order'){ const seq=Array.isArray(a)?a:[]; let sc=0; const correct=it.order; const n=Math.min(correct.length,seq.length); for(let i=0;i<n;i++){ if(seq[i]===correct[i]) sc++; } addScore(it, sc/correct.length, 1); }
    if(it.type==='classify'){ let totalItems=0, correctCnt=0; it.items.forEach(x=>{ totalItems++; const placed = Object.entries(a).find(([cat,arr])=> (arr||[]).includes(x.text)); if(placed && placed[0]===x.cat) correctCnt++; }); addScore(it, correctCnt/totalItems, 1); }
  }

  // Self (1-5) → 0-1 scale
  const selfK = val('#selfK'), selfP = val('#selfP'), selfA = val('#selfA');
  const self = {K:selfK/5, P:selfP/5, A:selfA/5};

  // Compute maxima per K/P/A
  const maxK = ITEMS.filter(i=>i.kpa==='K').length; const maxP = ITEMS.filter(i=>i.kpa==='P').length; const maxA = ITEMS.filter(i=>i.kpa==='A').length;
  const obs = {K:K/maxK, P:P/maxP, A:A/maxA, total: total/max};
  const gap = {K: self.K - obs.K, P: self.P - obs.P, A: self.A - obs.A};

  function level(x){ if(x<0.2) return 'L1'; if(x<0.4) return 'L2'; if(x<0.6) return 'L3'; if(x<0.8) return 'L4'; return 'L5'; }
  const levelObs = {K:level(obs.K), P:level(obs.P), A:level(obs.A), Overall:level(obs.total)};
  const levelSelf = {K:level(self.K), P:level(self.P), A:level(self.A), Overall:level((self.K+self.P+self.A)/3)};

  const out = {total, max, breakdown:{K,P,A, I_ม11:I11, I_ม12:I12}, obs, self, gap, levelObs, levelSelf};
  return {ans, detail, out};
}

function showSummary(res){
  const {total,max,breakdown,obs,self,gap,levelObs,levelSelf} = res.out;
  const pct = Math.round((total/max)*100);
  $('#scoreSummary').innerHTML = `คะแนนรวม: ${total.toFixed(2)} / ${max} (${pct}%)\n`
    + `K=${breakdown.K.toFixed(2)}  ·  P=${breakdown.P.toFixed(2)}  ·  A=${breakdown.A.toFixed(2)}\n`
    + `ม.1/1 = ${breakdown.I_ม11.toFixed(2)}  ·  ม.1/2 = ${breakdown.I_ม12.toFixed(2)}\n\n`
    + `Observed → K:${(obs.K*100).toFixed(0)}%  P:${(obs.P*100).toFixed(0)}%  A:${(obs.A*100).toFixed(0)}%  · Level ${levelObs.Overall}\n`
    + `Self → K:${(self.K*100).toFixed(0)}%  P:${(self.P*100).toFixed(0)}%  A:${(self.A*100).toFixed(0)}%  · Level ${levelSelf.Overall}\n`
    + `GAP (Self - Obs) → K:${(gap.K*100).toFixed(0)}%  P:${(gap.P*100).toFixed(0)}%  A:${(gap.A*100).toFixed(0)}%`;
}
function showDetail(res){ const lines = res.detail.map(d=>`ข้อ ${d.id} [${d.indicator}/${d.kpa}/${d.type}] → ${(d.score*1).toFixed(2)} / ${d.max}`); $('#detail').textContent = lines.join('\n'); }

/******************* ความคืบหน้า *******************/
function updateProgress(){
  const ans = collectAnswers(); let filled = 0;
  ITEMS.forEach(it=>{ if(ans[it.id]!==undefined){ if(it.type==='mcq' || it.type==='short'){ if(ans[it.id]!=='' && ans[it.id]!==undefined) filled++; } else { const v = ans[it.id]; if(it.type==='match') filled += Object.keys(v||{}).length?1:0; if(it.type==='order') filled += (Array.isArray(v) && v.length)?1:0; if(it.type==='classify'){ const sum = Object.values(v||{}).reduce((a,arr)=>a+(arr||[]).length,0); filled += sum?1:0; } } }});
  const pct = Math.round((filled/ITEMS.length)*100); $('#progBar').style.width = pct+'%'; $('#progText').textContent = `ความคืบหน้า ${filled}/${ITEMS.length}`;
}

/******************* Export CSV/JSON *******************/
function download(filename, text){ const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([text], {type:'text/plain'})); a.download=filename; a.click(); }
function exportJSON(){ const evalRes = evaluate(); const payload = { student:{name:$('#st_name').value,id:$('#st_id').value,class:$('#st_class').value,code:$('#test_code').value}, ...evalRes.out, answers: evalRes.ans, detail: evalRes.detail, reflect: {text: $('#reflectText').value} }; download(`history_m1_midterm_${Date.now()}.json`, JSON.stringify(payload, null, 2)); }
function exportCSV(){ const evalRes = evaluate(); const rows = []; rows.push(['name','id','class','code','total','max','K','P','A','M1_1','M1_2','obsK','obsP','obsA','selfK','selfP','selfA','gapK','gapP','gapA','levelObs','levelSelf']); const b=evalRes.out.breakdown, o=evalRes.out.obs, s=evalRes.out.self, g=evalRes.out.gap, lo=evalRes.out.levelObs, ls=evalRes.out.levelSelf; rows.push([$('#st_name').value,$('#st_id').value,$('#st_class').value,$('#test_code').value,evalRes.out.total,evalRes.out.max,b.K,b.P,b.A,b.I_ม11,b.I_ม12,o.K,o.P,o.A,s.K,s.P,s.A,g.K,g.P,g.A,lo.Overall,ls.Overall]); rows.push([]); rows.push(['item','type','indicator','kpa','score']); evalRes.detail.forEach(d=>rows.push([d.id,d.type,d.indicator,d.kpa,d.score])); const csv = rows.map(r=>r.map(x=>`"${(x??'').toString().replace(/"/g,'""')}"`).join(',')).join('\n'); download(`history_m1_midterm_${Date.now()}.csv`, csv); }

/******************* ส่งไป Google Sheets *******************/
async function postToSheets(){
  if(!CONFIG.SHEETS_WEBAPP_URL) return alert('ยังไม่ได้ตั้งค่า SHEETS_WEBAPP_URL');
  const evalRes = evaluate();
  const payload = {
    student:{name:$('#st_name').value,id:$('#st_id').value,class:$('#st_class').value,code:$('#test_code').value},
    summary: evalRes.out,
    detail: evalRes.detail,
    reflect: {text: $('#reflectText').value}
  };
  try{
    await fetch(CONFIG.SHEETS_WEBAPP_URL, {method:'POST', mode:'no-cors', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
    alert('ส่งข้อมูลไป Google Sheets แล้ว (ตรวจชีต Summary/Detail)');
  }catch(e){ alert('ส่งข้อมูลไม่สำเร็จ: '+e.message); }
}

/******************* Events *******************/
['input','change'].forEach(ev=>document.addEventListener(ev,()=>{syncSelfVals(); updateProgress(); saveToLocal();}));
$('#btnSubmit').addEventListener('click',()=>{ const res = evaluate(); showSummary(res); });
$('#btnShowDetail').addEventListener('click',()=>{ $('#detail').classList.toggle('hidden'); if(!$('#detail').classList.contains('hidden')) showDetail(evaluate()); });
$('#btnSave').addEventListener('click',saveToLocal);
$('#btnLoad').addEventListener('click',loadFromLocal);
$('#btnReset').addEventListener('click',()=>{ if(confirm('ล้างคำตอบทั้งหมด?')){ localStorage.clear(); render(); }});
$('#btnCSV').addEventListener('click',exportCSV);
$('#btnJSON').addEventListener('click',exportJSON);
$('#btnSheets').addEventListener('click',postToSheets);

// เริ่มต้น
render(); syncSelfVals();
</script>
</body>
</html>
