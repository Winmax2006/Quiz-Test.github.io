<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>Interactive History Quiz ‡∏°.2</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    :root{
      --bg:#0b122a;--panel:#0f1c3a;--card:#1e293b;--ink:#e6f1ff;--muted:#bcd3ff;--accent:#38bdf8;--accent2:#60a5fa;--ok:#22c55e;--warn:#f59e0b;--bad:#ef4444;
      --bd:#2b3f63;
    }
    *{box-sizing:border-box}
    body{font-family:"Noto Sans Thai",system-ui,Segoe UI,Inter,sans-serif;margin:0;background:radial-gradient(1200px 600px at 20% -10%, #132a57, transparent),linear-gradient(180deg,#0b1328,#0b122a 40%,#0a0f21);color:var(--ink)}
    header{position:sticky;top:0;z-index:10;background:rgba(15,28,58,.7);backdrop-filter:blur(8px);border-bottom:1px solid var(--bd)}
    .wrap{max-width:1000px;margin:auto;padding:18px}
    h1{margin:0;font-weight:800;color:var(--accent)}
    .sub{color:var(--muted)}
    .toolbar{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}
    .btn{appearance:none;border:1px solid var(--bd);background:linear-gradient(180deg,#0f1c3a,#0b162d);color:var(--ink);padding:10px 14px;border-radius:12px;cursor:pointer}
    .btn:hover{filter:brightness(1.15)}
    .btn.primary{background:linear-gradient(180deg,#1e40af,#1d4ed8);border-color:#2b5ad6}
    .btn.good{background:linear-gradient(180deg,#15803d,#16a34a);border-color:#1ea35a}
    main{max-width:1000px;margin:auto;padding:18px;display:grid;gap:16px}
    .card{background:linear-gradient(180deg,#152441,#0f1c3a);border:1px solid var(--bd);border-radius:16px;box-shadow:0 10px 24px rgba(0,0,0,.35)}
    .hd{padding:14px 16px;border-bottom:1px solid var(--bd)}
    .bd{padding:16px}
    .progress{height:10px;background:#0c1731;border:1px solid var(--bd);border-radius:999px;overflow:hidden}
    .bar{height:100%;width:0%;background:linear-gradient(90deg,var(--accent),var(--accent2))}
    .q{padding:14px;border-radius:14px;background:#0c1731;border:1px solid var(--bd);margin-bottom:14px}
    .q h3{margin:.2rem 0 0.6rem 0}
    .options{display:grid;gap:10px}
    .opt{display:flex;gap:10px;align-items:flex-start;padding:10px;border:1px solid var(--bd);background:#0b162d;border-radius:12px;cursor:pointer}
    .opt input{margin-top:3px}
    .pair-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .bank,.targets{border:1px dashed var(--bd);border-radius:12px;min-height:90px;padding:10px;background:#0b162d}
    .chip{display:inline-block;background:#1e293b;border:1px solid var(--bd);border-radius:999px;padding:6px 10px;margin:5px;cursor:grab}
    .slot{display:flex;align-items:center;gap:8px;border:1px solid var(--bd);background:#0b162d;border-radius:12px;padding:8px;margin:6px 0}
    .drop{min-width:80px;min-height:28px;border:1px dashed var(--bd);border-radius:999px;padding:4px 8px}
    .order{display:flex;flex-direction:column;gap:8px}
    .row{display:flex;gap:10px;align-items:center;border:1px solid var(--bd);border-radius:12px;background:#0b162d;padding:8px;cursor:grab}
    .row .drag{opacity:.7}
    textarea,input[type=text]{width:100%;padding:10px;border:1px solid var(--bd);border-radius:12px;background:#0b162d;color:var(--ink)}
    .viz{display:flex;justify-content:center;align-items:center;background:#0b162d;border:1px solid var(--bd);border-radius:12px;height:220px}
    svg{max-width:100%;height:200px}
    .marker{cursor:pointer;transition:transform .1s}
    .marker:hover{transform:scale(1.1)}
    .foot{display:flex;gap:10px;justify-content:flex-end}
    .note{color:var(--muted)}
    .sum-item{border:1px solid var(--bd);border-radius:12px;padding:10px;margin:8px 0;background:#0b162d}
    .mini{font-size:.9rem;color:var(--muted)}
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏•‡∏≤‡∏á‡∏†‡∏≤‡∏Ñ ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå ‡∏°.2</h1>
    <div class="sub">‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤: ‡∏™‡∏∏‡πÇ‡∏Ç‡∏ó‡∏±‡∏¢ ‚Äì ‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤ ‚Ä¢ ‡∏ú‡∏™‡∏°‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° ‚Ä¢ ‡∏£‡∏∞‡∏ö‡∏ö Partial Credit (1‚Äì5)</div>
    <div class="toolbar">
      <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏ü‡∏•‡πå -->
      <button class="btn" id="btnSave">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß</button>
      <button class="btn" id="btnExportCSV">Export CSV</button>
      <button class="btn" id="btnExportJSON">Export JSON</button>
      <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏ô‡∏≥‡∏ó‡∏≤‡∏á Web App -->
      <button class="btn" id="btnHome">üè† ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å</button>
      <button class="btn" id="btnPerf">üé® ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ Performance Task</button>
      <span class="sub" id="pill">‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°</span>
    </div>
    <div class="progress"><div class="bar" id="bar"></div></div>
  </div>
</header>

<main>
  <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ö -->
  <section class="card">
    <div class="hd"><b>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ö</b></div>
    <div class="bd">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
        <div><label>‡∏ä‡∏∑‡πà‡∏≠‚Äì‡∏™‡∏Å‡∏∏‡∏•<input type="text" id="stuName" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏¥‡∏ï‡∏ï‡∏¥‡∏Ñ‡∏∏‡∏ì ‡πÉ‡∏à‡∏î‡∏µ"></label></div>
        <div><label>‡∏£‡∏´‡∏±‡∏™/‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà<input type="text" id="stuId" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏°2/3 ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà 12"></label></div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:10px">
        <div><label>‡∏´‡πâ‡∏≠‡∏á/‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ô<input type="text" id="stuClass" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏°.2/3"></label></div>
        <div><label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏<input type="text" id="stuNote" placeholder="‡∏ñ‡πâ‡∏≤‡∏°‡∏µ"></label></div>
      </div>
      <div class="foot" style="margin-top:10px">
        <button class="btn" id="btnSaveInfo">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ö</button>
      </div>
    </div>
  </section>

  <!-- ‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î -->
  <section class="card">
    <div class="hd"><b>‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</b> <span class="mini">(20 ‡∏Ç‡πâ‡∏≠)</span></div>
    <div class="bd" id="stage"></div>
  </section>

  <!-- ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡πà‡∏≠ -->
  <section class="card">
    <div class="hd">‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡πà‡∏≠</div>
    <div class="bd">
      <div>‡∏ï‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß: <b id="done">0</b>/20 ‚Ä¢ ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥: <b id="score">0</b></div>
      <div class="note">‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡πÄ‡∏õ‡∏¥‡∏î ‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå/‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏π‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏û‡∏¥‡πà‡∏°</div>
      <div style="margin-top:10px">
        <button class="btn good" id="btnShowSummary">‡∏î‡∏π‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</button>
      </div>
      <div id="summaryBox" style="margin-top:12px"></div>
    </div>
  </section>
</main>

<script>
/* ========= ‡πÉ‡∏™‡πà URL ‡∏Ç‡∏≠‡∏á Web App (Deploy ‡πÅ‡∏•‡πâ‡∏ß) ========= */
const WEB_URL = "https://script.google.com/macros/s/AKfycbyj0SvyKfNtmWbnI7m2fhHTHvqP-Of-X8Y3SzjwOoj0C5gmi9dWM8Z-Iz8q3gexeAD4/exec";

/* ========= ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡πÑ‡∏õ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏´‡∏ô‡πâ‡∏≤ ========= */
const NAV = {
  base: WEB_URL,
  menu: `${WEB_URL}?page=Menu`,
  mcq:  `${WEB_URL}?page=MCQs`,
  perf: `${WEB_URL}?page=Perf`,
};
// ‡∏õ‡∏∏‡πà‡∏°‡∏ô‡∏≥‡∏ó‡∏≤‡∏á
document.getElementById('btnHome').onclick = ()=> window.location.href = NAV.menu;
document.getElementById('btnPerf').onclick = ()=> window.location.href = NAV.perf;

/* ========= ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö ========= */
// helpers
function o(text,score){return {text,score}};
function ctx(title,desc){return {title,desc}};
function qMcq(id,text,options,context){return {id,type:'mcq',text,options,context}};
function qMatch(id,text,pairs){return {id,type:'match',text,pairs}};
function qOrder(id,text,items,answerIdx){return {id,type:'order',text,items,answerIdx}};
function qHot(id,text,markers,context){return {id,type:'hotspot',text,markers,context}};
function qShort(id,text){return {id,type:'short',text}};
function qDoc(id,text){return {id,type:'doc',text}};

// ‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö (20 ‡∏Ç‡πâ‡∏≠)
const QUIZ=[
  qMcq(1,"‡∏Å‡∏≤‡∏£‡∏™‡∏ñ‡∏≤‡∏õ‡∏ô‡∏≤‡∏≠‡∏≤‡∏ì‡∏≤‡∏à‡∏±‡∏Å‡∏£‡∏™‡∏∏‡πÇ‡∏Ç‡∏ó‡∏±‡∏¢‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡πÉ‡∏ô‡∏£‡∏±‡∏ä‡∏™‡∏°‡∏±‡∏¢‡πÉ‡∏î?",[
    o("‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏ô‡πÄ‡∏£‡∏®‡∏ß‡∏£",1),o("‡∏û‡πà‡∏≠‡∏Ç‡∏∏‡∏ô‡∏®‡∏£‡∏µ‡∏≠‡∏¥‡∏ô‡∏ó‡∏£‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå",5),o("‡∏û‡πà‡∏≠‡∏Ç‡∏∏‡∏ô‡∏£‡∏≤‡∏°‡∏Ñ‡∏≥‡πÅ‡∏´‡∏á",4),o("‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡πÑ‡∏ï‡∏£‡πÇ‡∏•‡∏Å‡∏ô‡∏≤‡∏ñ",2),o("‡∏û‡∏£‡∏∞‡∏°‡∏´‡∏≤‡∏à‡∏±‡∏Å‡∏£‡∏û‡∏£‡∏£‡∏î‡∏¥",3)
  ],ctx("‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå","‡∏û‡πà‡∏≠‡∏Ç‡∏∏‡∏ô‡∏®‡∏£‡∏µ‡∏≠‡∏¥‡∏ô‡∏ó‡∏£‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå")),
  qMcq(2,"‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞‡∏Å‡∏≤‡∏£‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á‡∏™‡∏°‡∏±‡∏¢‡∏™‡∏∏‡πÇ‡∏Ç‡∏ó‡∏±‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏Ñ‡∏∑‡∏≠‡∏Ç‡πâ‡∏≠‡πÉ‡∏î?",[
    o("‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢‡∏ï‡∏£‡∏≤‡∏™‡∏≤‡∏°‡∏î‡∏ß‡∏á",1),o("‡∏û‡πà‡∏≠‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á‡∏•‡∏π‡∏Å",5),o("‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏û‡∏£‡πà",3),o("‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏∏‡∏ô‡∏°‡∏π‡∏•‡∏ô‡∏≤‡∏¢‡πÄ‡∏Ç‡πâ‡∏°‡∏á‡∏ß‡∏î",4),o("‡πÄ‡∏ô‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏ï‡∏Å",2)
  ],ctx("‡πÅ‡∏ô‡∏ß‡∏Ñ‡∏¥‡∏î","‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå‚Äì‡∏£‡∏≤‡∏©‡∏é‡∏£‡πÉ‡∏Å‡∏•‡πâ‡∏ä‡∏¥‡∏î")),
  qMcq(3,"‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏ó‡∏µ‡πà‡∏™‡∏∏‡πÇ‡∏Ç‡∏ó‡∏±‡∏¢‡∏£‡∏∏‡πà‡∏á‡πÄ‡∏£‡∏∑‡∏≠‡∏á‡∏î‡πâ‡∏≤‡∏ô‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£‡∏£‡∏°?",[
    o("‡∏Ñ‡πâ‡∏≤‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏ï‡∏Å",1),o("‡∏ä‡∏•‡∏õ‡∏£‡∏∞‡∏ó‡∏≤‡∏ô‡∏•‡∏∏‡πà‡∏°‡∏ô‡πâ‡∏≥‡∏¢‡∏°",5),o("‡∏™‡πà‡∏ß‡∏¢‡∏≠‡∏≤‡∏Å‡∏£",3),o("‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏à‡∏µ‡∏ô",4),o("‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢‡πÑ‡∏û‡∏£‡πà",2)
  ]),
  qMatch(4,"‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå‡∏Å‡∏±‡∏ö‡∏ú‡∏•‡∏á‡∏≤‡∏ô",[
    ["‡∏û‡πà‡∏≠‡∏Ç‡∏∏‡∏ô‡∏£‡∏≤‡∏°‡∏Ñ‡∏≥‡πÅ‡∏´‡∏á","‡∏õ‡∏£‡∏∞‡∏î‡∏¥‡∏©‡∏ê‡πå‡∏•‡∏≤‡∏¢‡∏™‡∏∑‡∏≠‡πÑ‡∏ó"],
    ["‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏ô‡πÄ‡∏£‡∏®‡∏ß‡∏£","‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏≠‡∏¥‡∏™‡∏£‡∏†‡∏≤‡∏û"],
    ["‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏£‡∏≤‡∏¢‡∏ì‡πå","‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏ù‡∏£‡∏±‡πà‡∏á‡πÄ‡∏®‡∏™"]
  ]),
  qOrder(5,"‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (‡πÄ‡∏Å‡πà‡∏≤‡∏™‡∏∏‡∏î ‚Üí ‡πÉ‡∏´‡∏°‡πà‡∏™‡∏∏‡∏î)",[
    "‡∏™‡∏ñ‡∏≤‡∏õ‡∏ô‡∏≤‡∏™‡∏∏‡πÇ‡∏Ç‡∏ó‡∏±‡∏¢","‡∏•‡∏≤‡∏¢‡∏™‡∏∑‡∏≠‡πÑ‡∏ó","‡∏™‡∏ñ‡∏≤‡∏õ‡∏ô‡∏≤‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤","‡πÄ‡∏™‡∏µ‡∏¢‡∏Å‡∏£‡∏∏‡∏á‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà 1"
  ],[0,1,2,3]),
  qHot(6,"‡∏à‡∏∏‡∏î‡πÉ‡∏î‡πÉ‡∏ô‡πÅ‡∏ú‡∏ô‡∏†‡∏≤‡∏û‡πÅ‡∏ó‡∏ô '‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤' ‡πÑ‡∏î‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î?",
    [
      {x:30,y:60,label:"A",score:3},
      {x:55,y:55,label:"B",score:5},
      {x:75,y:40,label:"C",score:2},
      {x:40,y:30,label:"D",score:4},
      {x:20,y:20,label:"E",score:1}
    ],ctx("‡∏Ñ‡∏≥‡πÉ‡∏ö‡πâ","‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤‡∏≠‡∏¢‡∏π‡πà‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏à‡πâ‡∏≤‡∏û‡∏£‡∏∞‡∏¢‡∏≤‡∏ï‡∏≠‡∏ô‡∏•‡πà‡∏≤‡∏á")),
  qDoc(7,"‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° '‡πÉ‡∏ô‡∏ô‡πâ‡∏≥‡∏°‡∏µ‡∏õ‡∏•‡∏≤ ‡πÉ‡∏ô‡∏ô‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≤‡∏ß' ‡∏Ç‡∏≠‡∏á‡∏®‡∏¥‡∏•‡∏≤‡∏à‡∏≤‡∏£‡∏∂‡∏Å‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏µ‡πà 1 ‡∏™‡∏∞‡∏ó‡πâ‡∏≠‡∏ô‡πÄ‡∏®‡∏£‡∏©‡∏ê‡∏Å‡∏¥‡∏à‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£?"),
  qShort(8,"‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏• 2 ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤‡πÄ‡∏™‡∏µ‡∏¢‡∏Å‡∏£‡∏∏‡∏á‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà 2 (2310)"),
  qMcq(9,"‡∏Å‡∏£‡∏∏‡∏á‡∏®‡∏£‡∏µ‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤‡∏™‡∏ñ‡∏≤‡∏õ‡∏ô‡∏≤‡πÇ‡∏î‡∏¢‡πÉ‡∏Ñ‡∏£?",[
    o("‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏ô‡πÄ‡∏£‡∏®‡∏ß‡∏£",3),o("‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏£‡∏≤‡∏°‡∏≤‡∏ò‡∏¥‡∏ö‡∏î‡∏µ‡∏ó‡∏µ‡πà 1",5),o("‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡πÑ‡∏ï‡∏£‡πÇ‡∏•‡∏Å‡∏ô‡∏≤‡∏ñ",4),o("‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏ô‡∏≤‡∏£‡∏≤‡∏¢‡∏ì‡πå",2),o("‡∏û‡∏£‡∏∞‡∏°‡∏´‡∏≤‡∏à‡∏±‡∏Å‡∏£‡∏û‡∏£‡∏£‡∏î‡∏¥",1)
  ]),
  qMcq(10,"‡∏Å‡∏≤‡∏£‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏™‡∏∏‡πÇ‡∏Ç‡∏ó‡∏±‡∏¢‡∏ï‡∏£‡∏á‡πÑ‡∏´‡∏ô?",[
    o("‡∏£‡∏ß‡∏°‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏≠‡∏≥‡∏ô‡∏≤‡∏à‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô",5),o("‡πÄ‡∏™‡∏£‡∏µ‡∏†‡∏≤‡∏û‡∏ó‡πâ‡∏≠‡∏á‡∏ñ‡∏¥‡πà‡∏ô",2),o("‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏∏‡∏ô‡∏°‡∏π‡∏•‡∏ô‡∏≤‡∏¢",1),o("‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡πÅ‡∏£‡∏á‡∏á‡∏≤‡∏ô",3),o("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏†‡∏≤‡∏©‡∏µ",4)
  ]),
  qMcq(11,"‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤‡∏£‡∏∏‡πà‡∏á‡πÄ‡∏£‡∏∑‡∏≠‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤‡∏Å‡∏±‡∏ö‡∏ä‡∏≤‡∏ï‡∏¥‡πÉ‡∏î‡∏°‡∏≤‡∏Å‡∏ä‡πà‡∏ß‡∏á‡πÅ‡∏£‡∏Å?",[
    o("‡∏ç‡∏µ‡πà‡∏õ‡∏∏‡πà‡∏ô",5),o("‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©",2),o("‡πÇ‡∏õ‡∏£‡∏ï‡∏∏‡πÄ‡∏Å‡∏™",4),o("‡∏ù‡∏£‡∏±‡πà‡∏á‡πÄ‡∏®‡∏™",3),o("‡∏à‡∏µ‡∏ô",1)
  ]),
  qMcq(12,"‡∏®‡∏¥‡∏•‡∏õ‡∏ß‡∏±‡∏í‡∏ô‡∏ò‡∏£‡∏£‡∏°‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤‡πÄ‡∏î‡πà‡∏ô‡∏î‡πâ‡∏≤‡∏ô‡πÉ‡∏î?",[
    o("‡πÇ‡∏Ç‡∏ô‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏°‡πÄ‡∏Å‡∏µ‡∏¢‡∏£‡∏ï‡∏¥‡πå",5),o("‡πÄ‡∏û‡∏•‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ö‡πâ‡∏≤‡∏ô",3),o("‡∏´‡∏ô‡∏±‡∏á‡∏ï‡∏∞‡∏•‡∏∏‡∏á",2),o("‡∏•‡∏∞‡∏Ñ‡∏£‡πÇ‡∏ó‡∏£‡∏ó‡∏±‡∏®‡∏ô‡πå",1),o("‡∏ö‡∏±‡∏•‡πÄ‡∏•‡∏ï‡πå",4)
  ]),
  qMcq(13,"‡πÑ‡∏ó‡∏¢‚Äì‡πÇ‡∏õ‡∏£‡∏ï‡∏∏‡πÄ‡∏Å‡∏™‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÉ‡∏î?",[
    o("‡πÄ‡∏ú‡∏¢‡πÅ‡∏û‡∏£‡πà‡∏û‡∏∏‡∏ó‡∏ò‡∏®‡∏≤‡∏™‡∏ô‡∏≤",2),o("‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏≠‡∏≤‡∏ß‡∏∏‡∏ò",5),o("‡∏™‡∏ñ‡∏≤‡∏õ‡∏ô‡∏≤‡∏£‡∏≤‡∏ä‡∏ß‡∏á‡∏®‡πå‡πÉ‡∏´‡∏°‡πà",1),o("‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡πÅ‡∏£‡∏á‡∏á‡∏≤‡∏ô",3),o("‡πÅ‡∏ï‡πà‡∏á‡∏á‡∏≤‡∏ô‡∏£‡∏≤‡∏ä‡∏ß‡∏á‡∏®‡πå",4)
  ]),
  qMcq(14,"‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢‡∏Å‡∏£‡∏∏‡∏á‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà 2?",[
    o("‡∏≠‡πà‡∏≠‡∏ô‡πÅ‡∏≠‡∏Å‡∏≤‡∏£‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á",5),o("‡∏†‡∏±‡∏¢‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥",1),o("‡πÇ‡∏£‡∏Ñ‡∏£‡∏∞‡∏ö‡∏≤‡∏î",2),o("‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô",3),o("‡∏£‡∏∏‡∏Å‡∏£‡∏≤‡∏ô‡∏ç‡∏µ‡πà‡∏õ‡∏∏‡πà‡∏ô",4)
  ]),
  qMcq(15,"‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏ô‡πÄ‡∏£‡∏®‡∏ß‡∏£‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏î‡πâ‡∏≤‡∏ô‡πÉ‡∏î?",[
    o("‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏≠‡∏¥‡∏™‡∏£‡∏†‡∏≤‡∏û‡∏à‡∏≤‡∏Å‡∏û‡∏°‡πà‡∏≤",5),o("‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏û‡∏£‡∏∞‡πÅ‡∏Å‡πâ‡∏ß‡∏°‡∏£‡∏Å‡∏ï",1),o("‡∏ó‡∏≥‡∏™‡∏ô‡∏ò‡∏¥‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡πÄ‡∏ö‡∏≤‡∏ß‡πå‡∏£‡∏¥‡∏á",2),o("‡∏ï‡∏£‡∏≤‡∏™‡∏≤‡∏°‡∏î‡∏ß‡∏á",3),o("‡∏Ñ‡πâ‡∏≤‡∏Å‡∏±‡∏ö‡∏ù‡∏£‡∏±‡πà‡∏á‡πÄ‡∏®‡∏™",4)
  ]),
  qMcq(16,"‡∏û‡∏á‡∏®‡∏≤‡∏ß‡∏î‡∏≤‡∏£‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡πÅ‡∏ö‡∏ö‡πÉ‡∏î?",[
    o("‡∏•‡∏≤‡∏¢‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå‡∏≠‡∏±‡∏Å‡∏©‡∏£",5),o("‡πÇ‡∏ö‡∏£‡∏≤‡∏ì‡∏Ñ‡∏î‡∏µ",3),o("‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏",2),o("‡πÑ‡∏°‡πà‡∏•‡∏≤‡∏¢‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå",4),o("‡∏°‡∏∏‡∏Ç‡∏õ‡∏≤‡∏ê‡∏∞",1)
  ]),
  qOrder(17,"‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ô‡∏µ‡πâ (‡πÄ‡∏Å‡πà‡∏≤‡∏™‡∏∏‡∏î ‚Üí ‡πÉ‡∏´‡∏°‡πà‡∏™‡∏∏‡∏î)",[
    "‡∏™‡∏ñ‡∏≤‡∏õ‡∏ô‡∏≤‡∏Å‡∏£‡∏∏‡∏á‡∏®‡∏£‡∏µ‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤","‡πÄ‡∏™‡∏µ‡∏¢‡∏Å‡∏£‡∏∏‡∏á‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà 1","‡∏™‡∏°‡πÄ‡∏î‡πá‡∏à‡∏û‡∏£‡∏∞‡∏ô‡πÄ‡∏£‡∏®‡∏ß‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏≠‡∏¥‡∏™‡∏£‡∏†‡∏≤‡∏û","‡πÄ‡∏™‡∏µ‡∏¢‡∏Å‡∏£‡∏∏‡∏á‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà 2"
  ],[0,1,2,3]),
  qMatch(18,"‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡πÅ‡∏ô‡∏ß‡∏Ñ‡∏¥‡∏î/‡∏á‡∏≤‡∏ô‡∏®‡∏¥‡∏•‡∏õ‡πå‡∏Å‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏¢",[
    ["‡∏û‡πà‡∏≠‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á‡∏•‡∏π‡∏Å","‡∏™‡∏∏‡πÇ‡∏Ç‡∏ó‡∏±‡∏¢"],
    ["‡πÇ‡∏Ç‡∏ô‚Äì‡∏£‡∏≤‡∏°‡πÄ‡∏Å‡∏µ‡∏¢‡∏£‡∏ï‡∏¥‡πå","‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤"],
    ["‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤‡∏Å‡∏±‡∏ö‡∏ç‡∏µ‡πà‡∏õ‡∏∏‡πà‡∏ô","‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤"]
  ]),
  qHot(19,"‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á '‡∏™‡∏∏‡πÇ‡∏Ç‡∏ó‡∏±‡∏¢' ‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡πÉ‡∏ô‡πÅ‡∏ú‡∏ô‡∏†‡∏≤‡∏û",[
    {x:25,y:30,label:"A",score:5},
    {x:50,y:20,label:"B",score:3},
    {x:70,y:35,label:"C",score:2},
    {x:40,y:55,label:"D",score:4},
    {x:80,y:65,label:"E",score:1}
  ]),
  qShort(20,"‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå: ‡∏´‡∏≤‡∏Å‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏∏‡∏ô‡∏ô‡∏≤‡∏á‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤‡∏ä‡πà‡∏ß‡∏á‡∏†‡∏±‡∏¢‡∏Ñ‡∏∏‡∏Å‡∏Ñ‡∏≤‡∏°‡∏à‡∏≤‡∏Å‡∏û‡∏°‡πà‡∏≤ ‡∏Ñ‡∏∏‡∏ì‡∏à‡∏∞‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á‡∏£‡∏±‡∏ö‡∏°‡∏∑‡∏≠ 2 ‡∏Ç‡πâ‡∏≠ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏™‡∏±‡πâ‡∏ô ‡πÜ")
];

/* ========= LocalStorage ========= */
const LS_KEY = 'm2_history_quiz_state_v1';

/* ========= State & Elements ========= */
const state={i:0,answers:{}};
const els={
  stage:document.getElementById('stage'),
  bar:document.getElementById('bar'),
};

/* ========= Toolbar events ========= */
document.getElementById('btnSave').onclick=()=>{ autosave(true); alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡πÅ‡∏•‡πâ‡∏ß'); };
document.getElementById('btnExportCSV').onclick=exportCSV;
document.getElementById('btnExportJSON').onclick=exportJSON;
document.getElementById('btnSaveInfo').onclick=()=>{ autosave(true); alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß'); };
document.getElementById('btnShowSummary').onclick=showSubmit;

/* ========= Autosave on inputs ========= */
['stuName','stuId','stuClass','stuNote'].forEach(id=>{
  document.getElementById(id).addEventListener('input', ()=>autosave());
});

/* ========= Restore, render, beforeunload ========= */
restoreFromLocalStorage();
renderAll();
window.addEventListener('beforeunload', autosave);

/* ========= Render ALL questions ========= */
function renderAll(){
  els.stage.innerHTML='';
  QUIZ.forEach((q,idx)=>{
    els.stage.appendChild(renderQuestion(q, idx+1));
  });
  updateHUD();
}

function renderQuestion(q, no){
  const box=document.createElement('div'); box.className='q';
  const h=document.createElement('h3'); 
  h.innerHTML=`‡∏Ç‡πâ‡∏≠ ${no}. ${q.text}`;
  box.appendChild(h);

  // ‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏£‡∏¥‡∏ö‡∏ó‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡πâ‡∏≠‡∏ô‡∏±‡πâ‡∏ô (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
  if(q.context || q.type==='doc'){
    const bx=document.createElement('div');
    const b=document.createElement('button'); b.className='btn'; b.textContent='‡∏î‡∏π‡∏ö‡∏£‡∏¥‡∏ö‡∏ó/‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô';
    b.onclick=()=>{
      if(q.context){ alert(`${q.context.title||'‡∏ö‡∏£‡∏¥‡∏ö‡∏ó'}:\n${q.context.desc}`); }
      else if(q.type==='doc'){ alert('‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô: ‡∏®‡∏¥‡∏•‡∏≤‡∏à‡∏≤‡∏£‡∏∂‡∏Å‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏µ‡πà 1 ‚Äî ‡∏ß‡∏•‡∏µ ‚Äú‡πÉ‡∏ô‡∏ô‡πâ‡∏≥‡∏°‡∏µ‡∏õ‡∏•‡∏≤ ‡πÉ‡∏ô‡∏ô‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≤‡∏ß‚Äù ‡∏™‡∏∞‡∏ó‡πâ‡∏≠‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏≠‡∏∏‡∏î‡∏°‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡πÅ‡∏•‡∏∞‡∏£‡∏∞‡∏ö‡∏ö‡∏ä‡∏•‡∏õ‡∏£‡∏∞‡∏ó‡∏≤‡∏ô'); }
    };
    bx.appendChild(b); box.appendChild(bx);
  }

  if(q.type==='mcq'){
    const opts=document.createElement('div'); opts.className='options';
    q.options.forEach((op,idx)=>{
      const lbl=document.createElement('label'); lbl.className='opt';
      const ip=document.createElement('input'); ip.type='radio'; ip.name='q'+q.id; ip.value=op.score; ip.dataset.index=idx;
      if(state.answers[q.id]?.choice===idx) ip.checked=true;
      ip.onchange=()=>{
        state.answers[q.id]={type:'mcq',choice:idx,score:op.score,choiceText:q.options[idx].text};
        updateHUD(); autosave();
      };
      lbl.append(ip, document.createTextNode(op.text));
      opts.appendChild(lbl);
    });
    box.appendChild(opts);
  }

  if(q.type==='match'){
    const wrap=document.createElement('div'); wrap.className='pair-grid';
    const bank=document.createElement('div'); bank.className='bank';
    const targets=document.createElement('div'); targets.className='targets';
    const lefts=q.pairs.map(p=>p[0]); const rights=q.pairs.map(p=>p[1]);

    lefts.forEach(txt=>{
      const chip=document.createElement('span'); chip.className='chip'; chip.textContent=txt; chip.draggable=true; chip.dataset.value=txt;
      chip.ondragstart=e=>e.dataTransfer.setData('text/plain',txt); bank.appendChild(chip);
    });
    bank.ondragover=e=>e.preventDefault();
    bank.ondrop=e=>{
      e.preventDefault();
      const val=e.dataTransfer.getData('text/plain');
      const chip=[...box.querySelectorAll('.chip')].find(c=>c.dataset.value===val);
      if(chip) bank.appendChild(chip);
      saveMatch();
    };
    rights.forEach(r=>{
      const slot=document.createElement('div'); slot.className='slot';
      const lab=document.createElement('div'); lab.textContent=r;
      const drop=document.createElement('div'); drop.className='drop';
      drop.ondragover=e=>e.preventDefault();
      drop.ondrop=e=>{
        e.preventDefault();
        const val=e.dataTransfer.getData('text/plain');
        const chip=[...box.querySelectorAll('.chip')].find(c=>c.dataset.value===val);
        if(chip) drop.appendChild(chip);
        saveMatch();
      };
      slot.append(lab,drop); targets.appendChild(slot);
    });
    function saveMatch(){
      const map={};
      [...targets.querySelectorAll('.slot')].forEach(s=>{
        const right=s.firstChild.textContent;
        const chip=s.querySelector('.chip');
        if(chip) map[right]=chip.dataset.value;
      });
      let ok=0; q.pairs.forEach(([L,R])=>{ if(map[R]===L) ok++; });
      const score=Math.round((ok/q.pairs.length)*5);
      state.answers[q.id]={type:'match',map,score};
      updateHUD(); autosave();
    }
    // restore
    const saved=state.answers[q.id]?.map;
    wrap.append(bank,targets); box.appendChild(wrap);
    if(saved){
      for(const [right,left] of Object.entries(saved)){
        const chip=[...bank.querySelectorAll('.chip')].find(c=>c.dataset.value===left) 
          || [...box.querySelectorAll('.chip')].find(c=>c.dataset.value===left);
        const slot=[...targets.querySelectorAll('.slot')].find(s=>s.firstChild.textContent===right);
        if(chip&&slot) slot.querySelector('.drop').appendChild(chip);
      }
    }
  }

  if(q.type==='order'){
    const list=document.createElement('div'); list.className='order';
    const currentOrder = state.answers[q.id]?.order || q.items.slice();
    currentOrder.forEach(txt=>{
      const row=document.createElement('div'); row.className='row'; row.draggable=true; row.textContent=txt;
      row.ondragstart=e=>{e.dataTransfer.setData('text/plain',txt); row.classList.add('drag');};
      row.ondragend=()=>row.classList.remove('drag');
      row.ondragover=e=>e.preventDefault();
      row.ondrop=e=>{
        e.preventDefault();
        const val=e.dataTransfer.getData('text/plain');
        const kids=[...list.children].map(x=>x.textContent);
        const from=kids.indexOf(val);
        const to=[...list.children].indexOf(row);
        if(from>-1){
          list.insertBefore(list.children[from], to>from? row.nextSibling: row);
          saveOrder();
        }
      };
      list.appendChild(row);
    });
    function saveOrder(){
      const order=[...list.children].map(x=>x.textContent);
      const correct=q.answerIdx.map(i=>q.items[i]).join('|');
      const cur=order.join('|');
      const sc = (correct===cur)?5: (commonPrefixLen(correct,cur)>=2?3:1);
      state.answers[q.id]={type:'order',order,score:sc};
      updateHUD(); autosave();
    }
    box.appendChild(list);
  }

  if(q.type==='hotspot'){
    const viz=document.createElement('div'); viz.className='viz';
    const svg=document.createElementNS('http://www.w3.org/2000/svg','svg'); svg.setAttribute('viewBox','0 0 100 70');
    const bg=document.createElementNS(svg.namespaceURI,'rect'); bg.setAttribute('x',5); bg.setAttribute('y',5); bg.setAttribute('width',90); bg.setAttribute('height',60); bg.setAttribute('fill','#0a1a35'); bg.setAttribute('stroke','#35507c'); svg.appendChild(bg);
    const savedChoice = state.answers[q.id]?.choice;
    q.markers.forEach((m,idx)=>{
      const g=document.createElementNS(svg.namespaceURI,'g'); g.classList.add('marker');
      const c=document.createElementNS(svg.namespaceURI,'circle'); c.setAttribute('cx',m.x); c.setAttribute('cy',m.y); c.setAttribute('r',3.2); c.setAttribute('fill', (savedChoice===idx)? '#22c55e':'#38bdf8');
      const t=document.createElementNS(svg.namespaceURI,'text'); t.setAttribute('x',m.x+4); t.setAttribute('y',m.y+1.5); t.setAttribute('fill','#c7e3ff'); t.setAttribute('font-size','4'); t.textContent=m.label;
      g.append(c,t);
      g.onclick=()=>{
        state.answers[q.id]={type:'hotspot',choice:idx,score:m.score,label:m.label};
        [...svg.querySelectorAll('circle')].forEach((cc,i)=> cc.setAttribute('fill', i===idx? '#22c55e':'#38bdf8'));
        updateHUD(); autosave();
      };
      svg.appendChild(g);
    });
    viz.appendChild(svg); box.appendChild(viz);
  }

  if(q.type==='short' || q.type==='doc'){
    const ta=document.createElement('textarea'); ta.placeholder='‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏™‡∏±‡πâ‡∏ô ‡πÜ ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà'; ta.value=state.answers[q.id]?.text||'';
    ta.oninput=()=>{ state.answers[q.id]={type:q.type,text:ta.value}; updateHUD(); autosave(); };
    box.appendChild(ta);
  }

  return box;
}

function commonPrefixLen(a,b){
  const A=a.split('|'),B=b.split('|'); let n=0;
  for(let i=0;i<Math.min(A.length,B.length);i++){ if(A[i]===B[i]) n++; else break; }
  return n;
}

/* ========= HUD / Progress ========= */
function updateHUD(){
  const autoTypes = new Set(['mcq','hotspot','match','order']);
  const totalAuto = QUIZ.filter(q=>autoTypes.has(q.type)).length * 5;
  let got=0, answered=0;
  for(const q of QUIZ){
    const ans=state.answers[q.id];
    if(ans) answered++;
    if(ans && autoTypes.has(q.type)) got += Number(ans.score||0);
  }
  document.getElementById('done').textContent = Object.keys(state.answers).length;
  document.getElementById('score').textContent = `${got}/${totalAuto}`;

  const pct = Math.min(100, Math.round(100*answered/QUIZ.length));
  els.bar.style.width = pct + '%';
  document.getElementById('pill').textContent = answered===0 ? '‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°' : `‡∏ï‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß ${answered}/${QUIZ.length}`;
}

/* ========= Insight ========= */
const topicByQ = {
  1:'‡∏™‡∏∏‡πÇ‡∏Ç‡∏ó‡∏±‡∏¢',2:'‡∏™‡∏∏‡πÇ‡∏Ç‡∏ó‡∏±‡∏¢',3:'‡∏™‡∏∏‡πÇ‡∏Ç‡∏ó‡∏±‡∏¢',4:'‡∏™‡∏∏‡πÇ‡∏Ç‡∏ó‡∏±‡∏¢',19:'‡∏™‡∏∏‡πÇ‡∏Ç‡∏ó‡∏±‡∏¢',
  6:'‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤',9:'‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤',10:'‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤',11:'‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤',12:'‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤',13:'‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤',14:'‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤',15:'‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤',16:'‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤',17:'‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤',18:'‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤'
};
function makeInsights(){
  const autoTypes = new Set(['mcq','hotspot','match','order']);
  const sec = {}; let totalAuto=0, gotAuto=0;
  for(const q of QUIZ){
    const ans=state.answers[q.id]; if(!ans) continue;
    if(autoTypes.has(q.type)){
      const s = Number(ans.score||0);
      const t = topicByQ[q.id] || '‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ';
      sec[t] = sec[t] || {got:0,total:0};
      sec[t].got += s; sec[t].total += 5;
      gotAuto += s; totalAuto += 5;
    }
  }
  const pct = totalAuto? Math.round(100*gotAuto/totalAuto):0;
  const msgs = [];
  msgs.push(`‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°: ${gotAuto}/${totalAuto} (${pct}%) ‚Äî ${gradeWord(pct)}`);
  for(const [k,v] of Object.entries(sec)){
    const p = v.total? Math.round(100*v.got/v.total):0;
    if(p>=80) msgs.push(`‡πÄ‡∏î‡πà‡∏ô: ‡∏™‡πà‡∏ß‡∏ô ‚Äú${k}‚Äù ‡∏ó‡∏≥‡πÑ‡∏î‡πâ‡∏î‡∏µ‡∏°‡∏≤‡∏Å (${p}%)`);
    else if(p>=60) msgs.push(`‡∏û‡∏≠‡πÉ‡∏ä‡πâ: ‡∏™‡πà‡∏ß‡∏ô ‚Äú${k}‚Äù ‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ (${p}%)`);
    else msgs.push(`‡∏Ñ‡∏ß‡∏£‡∏ó‡∏ö‡∏ó‡∏ß‡∏ô: ‡∏™‡πà‡∏ß‡∏ô ‚Äú${k}‚Äù ‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏Å‡∏ì‡∏ë‡πå (${p}%)`);
  }
  if((sec['‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤']?.got||0) < (sec['‡∏™‡∏∏‡πÇ‡∏Ç‡∏ó‡∏±‡∏¢']?.got||0)){
    msgs.push('‡∏Ç‡πâ‡∏≠‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ‡πÄ‡∏ô‡πâ‡∏ô ‚Äú‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤‚Äì‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‚Äù ‡πÄ‡∏û‡∏¥‡πà‡∏° (‡∏£‡∏ß‡∏°‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏≠‡∏≥‡∏ô‡∏≤‡∏à, ‡πÄ‡∏™‡∏µ‡∏¢‡∏Å‡∏£‡∏∏‡∏á, ‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤)');
  }
  return msgs.join('\n');
}
function gradeWord(p){ if(p>=85) return '‡∏¢‡∏≠‡∏î‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°'; if(p>=70) return '‡∏î‡∏µ'; if(p>=60) return '‡∏û‡∏≠‡πÉ‡∏ä‡πâ'; return '‡∏ï‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á'; }

/* ========= Summary ========= */
function showSubmit(){
  const autoTypes = new Set(['mcq','hotspot','match','order']);
  let totalAuto=0, gotAuto=0;
  const list=document.createElement('div');

  QUIZ.forEach(q=>{
    const ans=state.answers[q.id]; const item=document.createElement('div'); item.className='sum-item';
    let line=`‡∏Ç‡πâ‡∏≠ ${q.id} ‚Äì `;
    if(autoTypes.has(q.type)){
      const sc=Number(ans?.score||0); gotAuto+=sc; totalAuto+=5; line+=`‡πÑ‡∏î‡πâ ${sc}/5`;
    }else{ line+='‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡πÄ‡∏õ‡∏¥‡∏î (‡∏ï‡∏£‡∏ß‡∏à‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á)'; }
    item.textContent=line; list.appendChild(item);
  });

  const insights = makeInsights().replace(/\n/g,'<br>');
  const wrap=document.createElement('div');
  wrap.innerHTML=
    `<h3>‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô (‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)</h3>
     <div class="note">MCQ/Hotspot/‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà/‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö ‡∏ï‡∏£‡∏ß‡∏à‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏™‡πÄ‡∏Å‡∏• 1‚Äì5 ‚Ä¢ ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡πÄ‡∏õ‡∏¥‡∏î‡∏ï‡∏£‡∏ß‡∏à‡πÇ‡∏î‡∏¢‡∏Ñ‡∏£‡∏π</div>
     <div style="margin:10px 0;padding:10px;border:1px dashed var(--bd);border-radius:12px;background:#0b162d">
       <b>insight ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</b><br>${insights}
     </div>`;
  wrap.appendChild(list);

  const box=document.getElementById('summaryBox');
  box.innerHTML='';
  box.appendChild(wrap);
}

/* ========= Autosave / Restore ========= */
function getUserInfo(){
  return {
    name: document.getElementById('stuName')?.value?.trim()||'',
    id: document.getElementById('stuId')?.value?.trim()||'',
    cls: document.getElementById('stuClass')?.value?.trim()||'',
    note: document.getElementById('stuNote')?.value?.trim()||''
  };
}
function setUserInfo(u){
  if(!u) return;
  document.getElementById('stuName').value = u.name||'';
  document.getElementById('stuId').value = u.id||'';
  document.getElementById('stuClass').value = u.cls||'';
  document.getElementById('stuNote').value = u.note||'';
}
function autosave(force=false){
  clearTimeout(autosave._t);
  const doSave=()=>{
    const payload = { ts: Date.now(), version: 1, user: getUserInfo(), i: state.i, answers: state.answers };
    try{ localStorage.setItem(LS_KEY, JSON.stringify(payload)); }catch(e){ console.warn('LocalStorage error', e); }
  };
  if(force){ doSave(); } else { autosave._t = setTimeout(doSave, 250); }
}
function restoreFromLocalStorage(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(!raw) return;
    const data = JSON.parse(raw);
    if(!data) return;
    setUserInfo(data.user);
    state.i = Number.isInteger(data.i)? data.i : 0;
    state.answers = data.answers || {};
  }catch(e){ console.warn('Restore failed', e); }
}

/* ========= Exporters ========= */
function exportJSON(){
  const obj = buildExportObject();
  const blob = new Blob([JSON.stringify(obj,null,2)], {type:'application/json'});
  downloadBlob(blob, makeFileName('json'));
}
function exportCSV(){
  const obj = buildExportObject();
  const rows = [];
  rows.push(['timestamp','name','student_id','class','note','total_auto','max_auto','percent','insight'].map(csvCell).join(','));
  rows.push([
    obj.meta.timestamp, obj.meta.name, obj.meta.student_id, obj.meta.class, obj.meta.note,
    obj.summary.total_auto, obj.summary.max_auto, obj.summary.percent+'%', (obj.summary.insight||'').replace(/\n/g,' | ')
  ].map(csvCell).join(','));
  rows.push('qid,type,score,detail'.split(',').map(csvCell).join(','));
  obj.items.forEach(it=>{
    rows.push([it.qid, it.type, it.score, it.detail||''].map(csvCell).join(','));
  });
  const blob = new Blob([rows.join('\n')], {type:'text/csv;charset=utf-8;'});
  downloadBlob(blob, makeFileName('csv'));
}
function buildExportObject(){
  const autoTypes = new Set(['mcq','hotspot','match','order']);
  const items = []; let total=0, max=0;
  for(const q of QUIZ){
    const ans = state.answers[q.id]; let score = 0, detail='';
    if(ans){
      if(q.type==='mcq'){ score = Number(ans.score||0); detail = ans.choiceText||''; }
      else if(q.type==='hotspot'){ score = Number(ans.score||0); detail = ans.label? `‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ${ans.label}` : ''; }
      else if(q.type==='match'){ score = Number(ans.score||0); detail = ans.map? JSON.stringify(ans.map):''; }
      else if(q.type==='order'){ score = Number(ans.score||0); detail = ans.order? ans.order.join(' > '):''; }
      else if(q.type==='short' || q.type==='doc'){ detail = ans.text||''; }
    }
    if(autoTypes.has(q.type)){ total+=score; max+=5; }
    items.push({qid:q.id, type:q.type, score, detail});
  }
  const insight = makeInsights();
  const u = getUserInfo();
  return {
    meta:{ timestamp: new Date().toISOString(), name: u.name, student_id: u.id, class: u.cls, note: u.note },
    summary:{ total_auto: total, max_auto: max, percent: max? Math.round(100*total/max):0, insight },
    items
  };
}
function makeFileName(ext){
  const u = getUserInfo();
  const safe = (s)=> (s||'').replace(/[^\p{L}\p{N}_\-\.]+/gu,'_').slice(0,40) || 'anon';
  const t = new Date().toISOString().replace(/[:\.]/g,'-');
  return `M2History_${safe(u.class)}_${safe(u.name)}_${t}.${ext}`;
}
function downloadBlob(blob, filename){
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob); a.download = filename;
  document.body.appendChild(a); a.click();
  setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 0);
}
function csvCell(v){ const s = (v==null? '' : String(v)); return `"${s.replace(/"/g,'""')}"`; }
</script>
</body>
</html>
