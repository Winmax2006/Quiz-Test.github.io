<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>แบบทดสอบกลางภาค ร่างกายมนุษย์ ม.2 – K·P·A + Self (40 ข้อ)</title>
<style>
  :root{ --bg:#0b122a;--panel:#0f1c3a;--card:#16243f;--ink:#e6f1ff;--muted:#bcd3ff;--accent:#38bdf8;--accent2:#60a5fa;--ok:#22c55e;--warn:#f59e0b;--bad:#ef4444;--bd:#274064; }
  *{box-sizing:border-box}
  body{margin:0;font:16px/1.55 system-ui,Inter,"Noto Sans Thai",sans-serif;background:radial-gradient(1200px 800px at 20% -10%,#122048,transparent),linear-gradient(#0b122a,#091024);color:var(--ink)}
  header{position:sticky;top:0;background:rgba(10,18,40,.9);backdrop-filter:blur(8px);border-bottom:1px solid #1c2f54;z-index:30}
  header .wrap{max-width:1100px;margin:auto;display:flex;gap:16px;align-items:center;padding:12px 16px}
  h1{font-size:20px;margin:0}
  main{max-width:1100px;margin:24px auto;padding:0 16px 64px}
  .panel{background:var(--panel);border:1px solid #1f335b;border-radius:16px;padding:16px;margin:16px 0}
  .grid{display:grid;gap:12px}
  .g2{grid-template-columns:repeat(2,minmax(0,1fr))}
  .g3{grid-template-columns:repeat(3,minmax(0,1fr))}
  label{display:block;font-weight:600;margin-bottom:6px}
  input[type=text], textarea, select{width:100%;padding:10px 12px;background:#0e1a35;color:var(--ink);border:1px solid #2b4572;border-radius:10px}
  textarea{min-height:100px}
  .card{background:var(--card);border:1px solid var(--bd);border-radius:16px;padding:16px;margin:16px 0}
  .opt{display:flex;gap:10px;align-items:flex-start;margin:8px 0;padding:10px;border:1px solid #1f335a;border-radius:12px;background:#0d1b37}
  .opt input{margin-top:4px}
  .dropzone{min-height:44px;padding:8px;border:1px dashed #365285;border-radius:12px;background:#0a1a36}
  .token{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border-radius:999px;background:#14305a;border:1px solid #2b4a7f;margin:4px;cursor:grab}
  .cols{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .pair-row{display:grid;grid-template-columns:1fr 24px 1fr;align-items:center;gap:8px;margin:6px 0}
  .progress{height:8px;background:#0f2245;border-radius:999px;overflow:hidden;border:1px solid #1d3563}
  .bar{height:100%;width:0;background:linear-gradient(90deg,#31b2f3,#6aa7ff)}
  details{background:#0d1c3a;border:1px solid #203a6b;border-radius:12px;padding:10px 12px}
  .small{font-size:13px}
  .k{color:#94f}.p{color:#6df}.a{color:#9f6}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border:1px solid #2a426d;border-radius:999px;background:#0f1e3f;font-size:12px;color:#bcd3ff}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap}
  .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:12px;background:linear-gradient(180deg,var(--accent),var(--accent2));color:#04223a;border:0;font-weight:700;cursor:pointer}
  .btn.secondary{background:#18325e;color:var(--ink);border:1px solid #2a4b86}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>แบบทดสอบกลางภาค: ร่างกายมนุษย์ ม.2 – K·P·A (40 ข้อ)</h1>
    <div class="pill">Offline + Autosave</div>
  </div>
</header>
<main>
  <section class="panel">
    <details>
      <summary><strong>Blueprint & วิธีใช้</strong> (คลิกเพื่อเปิด)</summary>
      <div class="grid g2" style="margin-top:10px">
        <div>
          <h3>กรอบตัวชี้วัด K·P·A (ย่อ)</h3>
          <ul class="small">
            <li><b class="k">K (ความรู้)</b>: โครงสร้าง–หน้าที่ของระบบต่าง ๆ, ระดับการจัดระบบของร่างกาย, สมดุลภายใน</li>
            <li><b class="p">P (กระบวนการ)</b>: ใช้หลักฐาน/อ่านแผนภาพ, ออกแบบ–ตีความการทดลองง่าย ๆ, เลือกวิธีปฏิบัติที่เหมาะสม</li>
            <li><b class="a">A (การประยุกต์)</b>: สุขภาพและความปลอดภัย, โภชนาการ, ปฐมพยาบาลเบื้องต้น, การสื่อสารข้อมูลสุขภาพอย่างรับผิดชอบ</li>
          </ul>
          <p class="small" style="color:var(--muted)">สัดส่วนคะแนนรวม = 100 (K=30 / P=38 / A=32) • จำนวนข้อ: K 16 ข้อ, P 14 ข้อ, A 10 ข้อ</p>
        </div>
        <div>
          <h3>วิธีใช้งาน</h3>
          <ol class="small">
            <li>กรอกข้อมูลผู้สอบ → ทำข้อสอบ</li>
            <li>กด <b>คำนวณคะแนน</b> เพื่อดูสรุป K/P/A</li>
            <li>กด <b>ส่งออก CSV/JSON</b> เพื่อบันทึกผล</li>
          </ol>
        </div>
      </div>
    </details>
  </section>

  <section class="panel">
    <h2>ข้อมูลผู้สอบ</h2>
    <div class="grid g3">
      <div><label>ชื่อ–สกุล</label><input id="name" type="text" placeholder="เช่น เด็กชาย…"/></div>
      <div><label>รหัสนักเรียน/เลขที่</label><input id="sid" type="text" placeholder="เช่น ม2/1–15"/></div>
      <div><label>ห้อง</label><input id="room" type="text" placeholder="เช่น ม2/1"/></div>
    </div>
    <div class="progress" aria-label="progress"><div id="progbar" class="bar"></div></div>
    <p class="small" style="color:var(--muted)">ระบบบันทึกอัตโนมัติ (LocalStorage) • ใช้งานออฟไลน์ได้ • Chrome/Edge/Firefox</p>
  </section>

  <div id="quiz"></div>

  <section class="panel" id="selfPanel">
    <h2>Self-Assessment (ไม่คิดคะแนน)</h2>
    <div class="grid g3">
      <div>
        <label>K</label>
        <select id="selfK"><option value=""></option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option></select>
      </div>
      <div>
        <label>P</label>
        <select id="selfP"><option value=""></option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option></select>
      </div>
      <div>
        <label>A</label>
        <select id="selfA"><option value=""></option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option></select>
      </div>
    </div>
    <label>Reflection (2–3 ประโยค): จุดที่มั่นใจ/ยังสับสน/ข้อมูลที่อยากหาต่อ</label>
    <textarea id="reflection" placeholder="เขียนสะท้อนคิดสั้น ๆ"></textarea>
  </section>

  <section class="panel">
    <h2>สรุปผล</h2>
    <div class="grid g3">
      <div class="card"><b class="k">K</b>: <span id="sumK">0</span> / 30</div>
      <div class="card"><b class="p">P</b>: <span id="sumP">0</span> / 38</div>
      <div class="card"><b class="a">A</b>: <span id="sumA">0</span> / 32</div>
    </div>
    <div class="card">รวมคะแนนทั้งหมด: <b id="sumTotal">0 / 100</b></div>
    <div class="toolbar">
      <button class="btn" id="calcBtn">คำนวณคะแนน</button>
      <button class="btn secondary" id="exportCsvBtn" disabled>ส่งออก CSV</button>
      <button class="btn secondary" id="exportJsonBtn" disabled>ส่งออก JSON</button>
      <button class="btn secondary" id="resetBtn">ล้างคำตอบ (รีเซ็ต)</button>
    </div>
  </section>
</main>

<script>
// ========== Utilities ==========
const $ = (sel, root=document) => root.querySelector(sel);
const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
const byId = id => document.getElementById(id);
function shuffle(arr){ return arr.map(v=>[Math.random(),v]).sort((a,b)=>a[0]-b[0]).map(v=>v[1]); }
function download(filename, text){ const blob = new Blob([text], {type:'text/plain;charset=utf-8'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = filename; a.click(); URL.revokeObjectURL(url); }
function escapeCsv(val){ let s = String(val ?? '').replace(/\r?\n/g,' ').trim(); if (s.includes(',') || s.includes('"')) s = '"' + s.replace(/"/g,'""') + '"'; return s; }
function normalizeText(s){ return (s||'').toString().trim().toLowerCase().replace(/\s+/g,' '); }

// ========== QUIZ DATA (40 ข้อ) ==========
const QUIZ = {
  meta:{ title:"แบบทดสอบกลางภาค ร่างกายมนุษย์ ม.2 – K·P·A + Self", version:"1.0.0", weights:{K:30,P:38,A:32} },
  items:[
    // ===== K (16 ข้อ | รวม 30 คะแนน) =====
    {id:'Q1', dim:'K', points:2, type:'mcq', prompt:'ระบบใดทำหน้าที่แลกเปลี่ยนแก๊สในร่างกาย?', options:[
      {t:'ระบบย่อยอาหาร', ok:false},{t:'ระบบหายใจ', ok:true},{t:'ระบบหมุนเวียนเลือด', ok:false},{t:'ระบบขับถ่าย', ok:false}
    ]},
    {id:'Q2', dim:'K', points:2, type:'mcq', prompt:'หน่วยพื้นฐานของสิ่งมีชีวิตคืออะไร?', options:[
      {t:'เนื้อเยื่อ', ok:false},{t:'อวัยวะ', ok:false},{t:'เซลล์', ok:true},{t:'ระบบอวัยวะ', ok:false}
    ]},
    {id:'Q3', dim:'K', points:1.5, type:'mcq', prompt:'ออร์แกเนลล์ที่ควบคุมการทำงานของเซลล์คือ?', options:[
      {t:'ไรโบโซม', ok:false},{t:'ไมโตคอนเดรีย', ok:false},{t:'นิวเคลียส', ok:true},{t:'ไลโซโซม', ok:false}
    ]},
    {id:'Q4', dim:'K', points:2, type:'mcq', prompt:'เนื้อเยื่อใดหดตัวได้และทำให้เกิดการเคลื่อนไหว?', options:[
      {t:'เนื้อเยื่อบุผิว', ok:false},{t:'เนื้อเยื่อเกี่ยวพัน', ok:false},{t:'เนื้อเยื่อกล้ามเนื้อ', ok:true},{t:'เนื้อเยื่อประสาท', ok:false}
    ]},
    {id:'Q5', dim:'K', points:2, type:'mcq', prompt:'เอนไซม์ในน้ำลายที่เริ่มย่อยแป้งคือ?', options:[
      {t:'เปปซิน', ok:false},{t:'อะไมเลส', ok:true},{t:'ไลเปส', ok:false},{t:'ทริปซิน', ok:false}
    ]},
    {id:'Q6', dim:'K', points:2, type:'mcq', prompt:'การย่อยโปรตีนเริ่มต้นในอวัยวะใด?', options:[
      {t:'ปาก', ok:false},{t:'กระเพาะอาหาร', ok:true},{t:'ลำไส้ใหญ่', ok:false},{t:'ตับ', ok:false}
    ]},
    {id:'Q7', dim:'K', points:2, type:'mcq', prompt:'หลอดเลือดชนิดใดนำเลือดออกจากหัวใจ?', options:[
      {t:'หลอดเลือดดำ', ok:false},{t:'หลอดเลือดฝอย', ok:false},{t:'หลอดเลือดแดง', ok:true},{t:'หลอดน้ำเหลือง', ok:false}
    ]},
    {id:'Q8', dim:'K', points:2, type:'mcq', prompt:'เม็ดเลือดแดงมีหน้าที่หลักคืออะไร?', options:[
      {t:'กำจัดเชื้อโรค', ok:false},{t:'ลำเลียงออกซิเจน', ok:true},{t:'แข็งตัวของเลือด', ok:false},{t:'สร้างฮอร์โมน', ok:false}
    ]},
    {id:'Q9', dim:'K', points:2, type:'mcq', prompt:'ฮอร์โมนใดจากตับอ่อนช่วยลดระดับน้ำตาลในเลือด?', options:[
      {t:'กลูคากอน', ok:false},{t:'อินซูลิน', ok:true},{t:'อะดรีนาลีน', ok:false},{t:'ไทรอกซิน', ok:false}
    ]},
    {id:'Q10', dim:'K', points:1.5, type:'short', prompt:'ถุงอากาศเล็ก ๆ ในปอดที่แลกเปลี่ยนแก๊สเรียกว่า ______', answers:['ถุงลมปอด','ถุงลม','alveoli']},
    {id:'Q11', dim:'K', points:2, type:'mcq', prompt:'อวัยวะหลักของระบบขับถ่ายที่กรองของเสียจากเลือดคือ?', options:[
      {t:'ไต', ok:true},{t:'ตับ', ok:false},{t:'ม้าม', ok:false},{t:'กระเพาะปัสสาวะ', ok:false}
    ]},
    {id:'Q12', dim:'K', points:2, type:'mcq', prompt:'สมองและไขสันหลังเป็นส่วนของระบบประสาทใด?', options:[
      {t:'ระบบประสาทส่วนปลาย', ok:false},{t:'ระบบประสาทอัตโนมัติ', ok:false},{t:'ระบบประสาทส่วนกลาง', ok:true},{t:'ระบบต่อมไร้ท่อ', ok:false}
    ]},
    {id:'Q13', dim:'K', points:2, type:'mcq', prompt:'หน้าที่ใดต่อไปนี้เป็นของโครงกระดูก?', options:[
      {t:'ผลิตฮอร์โมนอินซูลิน', ok:false},{t:'ป้องกันอวัยวะสำคัญและพยุงร่างกาย', ok:true},{t:'แลกเปลี่ยนแก๊ส', ok:false},{t:'ย่อยอาหาร', ok:false}
    ]},
    {id:'Q14', dim:'K', points:1.5, type:'mcq', prompt:'กล้ามเนื้อชนิดใดควบคุมไม่ได้โดยจิตใจ?', options:[
      {t:'กล้ามเนื้อลาย', ok:false},{t:'กล้ามเนื้อเรียบ', ok:true},{t:'กล้ามเนื้อโครงร่าง', ok:false},{t:'ทั้งหมดควบคุมได้', ok:false}
    ]},
    {id:'Q15', dim:'K', points:2, type:'mcq', prompt:'รีเฟล็กซ์เข่ากระตุกเกี่ยวข้องกับโครงสร้างใดเป็นหลัก?', options:[
      {t:'ไขสันหลัง', ok:true},{t:'สมองใหญ่', ok:false},{t:'สมองน้อย', ok:false},{t:'ต่อมใต้สมอง', ok:false}
    ]},
    {id:'Q16', dim:'K', points:1.5, type:'short', prompt:'การรักษาสภาพแวดล้อมภายในให้คงที่ของร่างกายเรียกว่า ______', answers:['สมดุลภายใน','โฮมิโอสเตซิส','homeostasis']},

    // ===== P (14 ข้อ | รวม 38 คะแนน) =====
    {id:'Q17', dim:'P', points:2, type:'mcq', prompt:'ขณะหายใจเข้า กระบังลมมีการเปลี่ยนแปลงอย่างไร?', options:[
      {t:'คลายตัวและโก่งขึ้น', ok:false},{t:'หดตัวและแบนราบลง', ok:true},{t:'หนาตัวขึ้น', ok:false},{t:'ไม่เปลี่ยนแปลง', ok:false}
    ]},
    {id:'Q18', dim:'P', points:2, type:'mcq', prompt:'เลือดไหลจากเอเทรียมซ้ายสู่เวนทริเคิลซ้ายผ่านลิ้นใด?', options:[
      {t:'ไตรคัสปิด', ok:false},{t:'ไมตรัล/ไบคัสปิด', ok:true},{t:'เอออร์ติกวาล์ว', ok:false},{t:'พัลโมนารียาล์ว', ok:false}
    ]},
    {id:'Q19', dim:'P', points:6, type:'match', prompt:'จับคู่ อวัยวะย่อยอาหาร ↔ หน้าที่เด่น', pairs:[
      {L:'ปาก', R:'เริ่มย่อยแป้งด้วยอะไมเลส'},
      {L:'กระเพาะอาหาร', R:'เริ่มย่อยโปรตีนด้วยกรดและเอนไซม์'},
      {L:'ลำไส้เล็ก', R:'ดูดซึมสารอาหารส่วนใหญ่'},
      {L:'ตับอ่อน', R:'สร้างเอนไซม์ย่อยอาหาร'}
    ]},
    {id:'Q20', dim:'P', points:2, type:'mcq', prompt:'เลือดที่ไหลไปปอดทางหลอดเลือดแดงปอดเป็นเลือดชนิดใด?', options:[
      {t:'เลือดแดง ออกซิเจนสูง', ok:false},{t:'เลือดดำ ออกซิเจนต่ำ', ok:true},{t:'เลือดผสม', ok:false},{t:'ไม่มีถูก', ok:false}
    ]},
    {id:'Q21', dim:'P', points:2, type:'mcq', prompt:'เหตุใดถุงลมปอดจึงเหมาะต่อการแลกเปลี่ยนแก๊ส?', options:[
      {t:'ผนังหนาและไม่มีเลือดมาเลี้ยง', ok:false},{t:'ผนังบางและมีเส้นเลือดฝอยหนาแน่น', ok:true},{t:'มีน้ำปริมาณมากขังอยู่', ok:false},{t:'มีเซลล์กล้ามเนื้อมาก', ok:false}
    ]},
    {id:'Q22', dim:'P', points:0.5, type:'short', prompt:'หน่วยโครงสร้างและหน้าที่ของไตคือ ______', answers:['นีฟรอน','nephron']},
    {id:'Q23', dim:'P', points:6, type:'match', prompt:'จับคู่ ฮอร์โมน ↔ ผลทางสรีรวิทยา', pairs:[
      {L:'อินซูลิน', R:'ลดระดับน้ำตาลในเลือด'},
      {L:'กลูคากอน', R:'เพิ่มระดับน้ำตาลในเลือด'},
      {L:'อะดรีนาลีน', R:'กระตุ้นหัวใจ/เตรียมพร้อมฉุกเฉิน'},
      {L:'ไทรอกซิน', R:'เร่งอัตราเมตาบอลิซึม'}
    ]},
    {id:'Q24', dim:'P', points:0.5, type:'short', prompt:'ค่า 120/80 mmHg หมายถึงความดัน ______ / ______ ของหัวใจ', keyw:['ซิสโตลิก','ไดแอสโตลิก','บีบตัว','คลายตัว']},
    {id:'Q25', dim:'P', points:2, type:'mcq', prompt:'หน้าที่หลักของหลอดเลือดฝอยคืออะไร?', options:[
      {t:'พาเลือดออกจากหัวใจ', ok:false},{t:'พาเลือดกลับหัวใจ', ok:false},{t:'แลกเปลี่ยนสารและแก๊สกับเนื้อเยื่อ', ok:true},{t:'ทำให้เลือดแข็งตัว', ok:false}
    ]},
    {id:'Q26', dim:'P', points:6, type:'categorize', prompt:'จัดหมวดตัวอย่างอาหารตามสารอาหารหลัก', cats:{
      'คาร์โบไฮเดรต':['ข้าวสวย','ขนมปัง','น้ำตาลทราย'],
      'โปรตีน':['ไข่ต้ม','ถั่วลิสง'],
      'ไขมัน':['น้ำมันพืช','เนย']
    }},
    {id:'Q27', dim:'P', points:0.5, type:'short', prompt:'การสลายสารอาหารเพื่อให้ได้พลังงานในระดับเซลล์เรียกว่า ______', answers:['การหายใจระดับเซลล์','cellular respiration','การหายใจภายใน']},
    {id:'Q28', dim:'P', points:2, type:'mcq', prompt:'ข้อใด <u>ไม่ใช่</u> ส่วนของโค้งรีเฟล็กซ์', options:[
      {t:'ตัวรับความรู้สึก', ok:false},{t:'เซลล์ประสาทรับความรู้สึก', ok:false},{t:'เซลล์เม็ดเลือดแดง', ok:true},{t:'เซลล์ประสาทสั่งงาน', ok:false}
    ]},
    {id:'Q29', dim:'P', points:6, type:'categorize', prompt:'จัดหมวด “ระบบประสาทส่วนกลาง” vs “ระบบประสาทส่วนปลาย”', cats:{
      'ส่วนกลาง':['สมอง','ไขสันหลัง'],
      'ส่วนปลาย':['เส้นประสาทสมอง','เส้นประสาทไขสันหลัง','ปลายประสาทรับสัมผัส']
    }},
    {id:'Q30', dim:'P', points:0.5, type:'short', prompt:'การปฏิสนธิของมนุษย์เกิดขึ้นที่ ______', answers:['ท่อนำไข่','ปีกมดลูก','oviduct','fallopian tube']},

    // ===== A (10 ข้อ | รวม 32 คะแนน) =====
    {id:'Q31', dim:'A', points:2, type:'mcq', prompt:'หลังวิ่ง 30 นาที ควรเลือกเมนูใดเพื่อฟื้นตัวได้ดี?', options:[
      {t:'ข้าวสวยกับอกไก่ต้ม', ok:true},{t:'มันทอด + น้ำอัดลม', ok:false},{t:'ขนมหวานล้วน ๆ', ok:false},{t:'กาแฟเข้มแทนมื้ออาหาร', ok:false}
    ]},
    {id:'Q32', dim:'A', points:2, type:'mcq', prompt:'แผลเลือดออกมาก ควรทำอย่างไรเป็นอันดับแรก?', options:[
      {t:'กดห้ามเลือดด้วยผ้าสะอาดที่แผล', ok:true},{t:'รอให้เลือดหยุดเอง', ok:false},{t:'ล้างแผลด้วยแอลกอฮอล์แรง ๆ ทันที', ok:false},{t:'ยกขาสูงและไม่กดแผล', ok:false}
    ]},
    {id:'Q33', dim:'A', points:2, type:'mcq', prompt:'ต้องการพลังงานระยะสั้นก่อนกีฬา ควรเน้นสารอาหารใด?', options:[
      {t:'คาร์โบไฮเดรตเชิงซ้อน', ok:true},{t:'ไขมันอิ่มตัว', ok:false},{t:'โซเดียม', ok:false},{t:'วิตามินเฉพาะอย่างเดียว', ok:false}
    ]},
    {id:'Q34', dim:'A', points:2, type:'mcq', prompt:'ท้องผูกบ่อย ควรปรับพฤติกรรมใดก่อน?', options:[
      {t:'เพิ่มผักผลไม้และดื่มน้ำมากขึ้น', ok:true},{t:'ลดการขยับร่างกาย', ok:false},{t:'งดน้ำทั้งหมด', ok:false},{t:'ทานอาหารมันเพิ่ม', ok:false}
    ]},
    {id:'Q35', dim:'A', points:4, type:'ms', prompt:'เลือกแนวทางลดความเสี่ยงโรคไม่ติดต่อเรื้อรัง (NCDs)', options:[
      {t:'กินผักผลไม้เพิ่ม', ok:true},{t:'ออกกำลังกายสม่ำเสมอ', ok:true},{t:'นอนดึกเป็นประจำ', ok:false},{t:'ลดน้ำตาลและเครื่องดื่มหวาน', ok:true}
    ]},
    {id:'Q36', dim:'A', points:4, type:'ms', prompt:'ดูแลระบบหายใจให้แข็งแรง ควรทำสิ่งใด', options:[
      {t:'หลีกเลี่ยงควันบุหรี่/มลพิษ', ok:true},{t:'ออกกำลังกายแบบแอโรบิก', ok:true},{t:'อยู่ในที่อับอากาศนาน ๆ', ok:false},{t:'ฝึกการหายใจลึกเป็นระยะ', ok:true}
    ]},
    {id:'Q37', dim:'A', points:4, type:'ms', prompt:'การใช้ยาอย่างปลอดภัย ควร...', options:[
      {t:'อ่านฉลากและปฏิบัติตามคำแนะนำ', ok:true},{t:'ใช้ยาปฏิชีวนะกับหวัดไวรัสเอง', ok:false},{t:'ไม่แบ่งยาให้ผู้อื่น', ok:true},{t:'ปรับขนาดยาเองตามใจชอบ', ok:false}
    ]},
    {id:'Q38', dim:'A', points:4, type:'ms', prompt:'ป้องกันโรคทางเดินอาหาร ควร...', options:[
      {t:'ล้างมือก่อนกินอาหาร', ok:true},{t:'กินอาหารสุกสะอาด', ok:true},{t:'ดื่มน้ำสะอาด', ok:true},{t:'กินอาหารค้างคืนโดยไม่อุ่น', ok:false}
    ]},
    {id:'Q39', dim:'A', points:4, type:'short', prompt:'เสนอแผนดูแลสุขภาพหัวใจ 1 สัปดาห์ (อาหาร/การออกกำลัง/พักผ่อน) พร้อมเหตุผลย่อ', keyw:['คาร์ดิโอ','ผัก','น้ำตาล','นอน','ความดัน','อัตราการเต้น','เป้าหมาย']},
    {id:'Q40', dim:'A', points:4, type:'short', prompt:'อธิบายเหตุผลของการคัดกรองอาการและแยกผู้ป่วยในห้องเรียนเพื่อป้องกันการแพร่เชื้อ', keyw:['ละอองฝอย','ระยะห่าง','หน้ากาก','ระบายอากาศ','แพร่เชื้อ']}
  ]
};

// ========== Render ==========
const quizEl = byId('quiz');
function render(){
  quizEl.innerHTML = '';
  const dims = [
    {key:'K', title:'ส่วนที่ 1: ความรู้ (K)', target: QUIZ.meta.weights.K},
    {key:'P', title:'ส่วนที่ 2: กระบวนการ (P)', target: QUIZ.meta.weights.P},
    {key:'A', title:'ส่วนที่ 3: การประยุกต์ (A)', target: QUIZ.meta.weights.A}
  ];
  dims.forEach(d=>{
    const items = QUIZ.items.filter(x=>x.dim===d.key);
    const totalPts = items.reduce((s,x)=>s+x.points,0);
    const sec = document.createElement('section'); sec.className='panel';
    const h = document.createElement('h2'); h.textContent = `${d.title} — ${items.length} ข้อ / ${totalPts} คะแนน`; sec.appendChild(h);
    items.forEach((q,idx)=> sec.appendChild(renderItem(q, idx+1, d.key)) );
    quizEl.appendChild(sec);
  });
  restoreState();
  updateProgress();
}

function renderItem(q, num, dim){
  const card = document.createElement('div'); card.className = 'card';
  const head = document.createElement('div');
  head.innerHTML = `<h3>${q.id}. <span style=\"opacity:.8\">(${q.points} คะแนน / ${dim})</span></h3><div class=\"qwrap\">${q.prompt}</div>`;
  card.appendChild(head);
  const body = document.createElement('div');

  if(q.type==='mcq'){
    const name = q.id;
    (q.options||[]).forEach((op,i)=>{
      const row = document.createElement('label'); row.className='opt';
      row.innerHTML = `<input type=\"radio\" name=\"${name}\" value=\"${i}\"> <div>${op.t}</div>`;
      body.appendChild(row);
    });
  } else if(q.type==='ms'){
    (q.options||[]).forEach((op,i)=>{
      const row = document.createElement('label'); row.className='opt';
      row.innerHTML = `<input type=\"checkbox\" data-id=\"${q.id}\" value=\"${i}\"> <div>${op.t}</div>`;
      body.appendChild(row);
    });
  } else if(q.type==='short'){
    const ta = document.createElement('textarea'); ta.placeholder = 'พิมพ์คำตอบสั้น ๆ'; ta.dataset.id=q.id; body.appendChild(ta);
  } else if(q.type==='match'){
    const pairs = q.pairs.map(p=>({...p}));
    const L = pairs; const rights = shuffle(pairs.map(p=>p.R));
    const pairsWrap = document.createElement('div');
    L.forEach((p,i)=>{
      const row = document.createElement('div'); row.className='pair-row';
      row.innerHTML = `<div class=\"small\" style=\"color:var(--muted)\">${p.L}</div><div class=\"center\">→</div>`;
      const dz = document.createElement('div'); dz.className='dropzone'; dz.dataset.id = q.id+"__L"+i; dz.dataset.expect = p.R; row.appendChild(dz);
      pairsWrap.appendChild(row);
    });
    const tokenBox = document.createElement('div'); rights.forEach(r=>{ const t=document.createElement('span'); t.textContent=r; t.className='token'; t.draggable=true; t.dataset.val=r; t.dataset.from=q.id; tokenBox.appendChild(t); });
    const cols = document.createElement('div'); cols.className='cols';
    const leftBox = document.createElement('div'); leftBox.appendChild(pairsWrap);
    const rightBox = document.createElement('div'); rightBox.innerHTML='<div class="small" style="color:var(--muted)">ลากปุ่มสีน้ำเงินมาวางที่ช่องว่าง</div>'; rightBox.appendChild(tokenBox);
    cols.appendChild(leftBox); cols.appendChild(rightBox); body.appendChild(cols);
  } else if(q.type==='categorize'){
    const allItems = shuffle(Object.values(q.cats).flat());
    const binsWrap = document.createElement('div'); binsWrap.className='cols';
    Object.keys(q.cats).forEach(cat=>{
      const box = document.createElement('div'); box.className='card';
      box.innerHTML = `<b>${cat}</b><div class=\"dropzone\" data-cat=\"${cat}\" data-id=\"${q.id}\"></div>`; binsWrap.appendChild(box);
    });
    const src = document.createElement('div'); src.className='card';
    const srcList = document.createElement('div');
    allItems.forEach(it=>{ const t=document.createElement('span'); t.textContent=it; t.className='token'; t.draggable=true; t.dataset.val=it; t.dataset.from=q.id; srcList.appendChild(t); });
    src.innerHTML='<b>ลากไปใส่หมวดหมู่ที่ถูกต้อง</b>'; src.appendChild(srcList);
    const cols = document.createElement('div'); cols.className='cols'; cols.appendChild(src); cols.appendChild(binsWrap); body.appendChild(cols);
  }

  card.appendChild(body);
  return card;
}

// Drag & Drop for tokens
let dragToken=null;
document.addEventListener('dragstart',e=>{ if(e.target.classList.contains('token')) dragToken=e.target; });
document.addEventListener('dragover',e=>{ if(e.target.classList.contains('dropzone')) e.preventDefault(); });
document.addEventListener('drop',e=>{ if(!dragToken) return; const dz=e.target.closest(' .dropzone'); if(dz){ dz.appendChild(dragToken); saveState(); updateProgress(); }});

document.addEventListener('change', e=>{ if(e.target.matches('input, select')){ saveState(); updateProgress(); } });
document.addEventListener('input', e=>{ if(e.target.matches('textarea')){ saveState(); updateProgress(); } });

// ========== Scoring ==========
function scoreItem(q){
  if(q.type==='mcq'){
    const sel = $$(`input[name="${q.id}"]:checked`);
    if(sel.length===0) return {pts:0, resp:''};
    const i = parseInt(sel[0].value,10); const ok = q.options[i]?.ok; return {pts: ok? q.points:0, resp: q.options[i]?.t||''};
  }
  if(q.type==='ms'){
    const cbs = $$(`input[type=checkbox][data-id="${q.id}"]`); if(cbs.length===0) return {pts:0, resp:''};
    let selIdx=[], selTxt=[]; cbs.forEach((cb,i)=>{ if(cb.checked){ selIdx.push(i); selTxt.push(q.options[i].t);} });
    const totalCorrect = q.options.filter(o=>o.ok).length;
    const correctSelected = selIdx.filter(i=>q.options[i].ok).length;
    const wrongSelected = selIdx.filter(i=>!q.options[i].ok).length;
    let frac = Math.max(0, (correctSelected/Math.max(1,totalCorrect)) - (wrongSelected/Math.max(1,q.options.length-totalCorrect))*0.5 );
    const pts = Math.round(q.points * frac * 100)/100; return {pts, resp: selTxt.join(' | ')};
  }
  if(q.type==='short'){
    const ta = $$(`textarea[data-id="${q.id}"]`)[0]; const ans = normalizeText(ta?.value||''); if(!ans) return {pts:0, resp:''};
    if(q.answers){ const ok = q.answers.some(a=> ans.includes(normalizeText(a)) ); return {pts: ok? q.points:0, resp: ta.value}; }
    if(q.keyw){ let hit=0; q.keyw.forEach(k=>{ if(ans.includes(normalizeText(k))) hit++; }); const pts = hit>=2? q.points : (hit===1? Math.round(q.points*0.5):0); return {pts, resp: ta.value}; }
    return {pts:0, resp:ta.value};
  }
  if(q.type==='match'){
    const rows = $$(`.dropzone[data-id^="${q.id}__L"]`); const per = q.points / rows.length; let pts=0, resp=[];
    rows.forEach(r=>{ const tok=r.querySelector('.token'); const got = tok?.dataset.val||''; const expect = r.dataset.expect; if(got && normalizeText(got)===normalizeText(expect)) pts+=per; resp.push(`${r.previousSibling.previousSibling?.textContent||''}=>${got}`); });
    return {pts: Math.round(pts*100)/100, resp: resp.join(' | ')};
  }
  if(q.type==='categorize'){
    const cats = Object.keys(q.cats); const total = Object.values(q.cats).flat().length; const per = q.points/total; let pts=0; let resp=[];
    cats.forEach(cat=>{ const box = $(`.dropzone[data-id="${q.id}"][data-cat="${cat}"]`); const toks = $$('.token', box); toks.forEach(t=>{ if(q.cats[cat].includes(t.dataset.val)) pts+=per; }); resp.push(`${cat}:{${toks.map(t=>t.dataset.val).join('; ')}}`); });
    return {pts: Math.round(pts*100)/100, resp: resp.join(' | ')};
  }
  return {pts:0, resp:''};
}

function compute(){
  const sums = {K:0,P:0,A:0,total:0}; const answers = [];
  QUIZ.items.forEach(q=>{ const {pts, resp} = scoreItem(q); sums[q.dim]+=pts; sums.total += pts; answers.push({id:q.id, dim:q.dim, type:q.type, pts, resp}); });
  for(const k of ['K','P','A','total']) sums[k] = Math.round(sums[k]*100)/100;
  return {sums, answers};
}

// ========== State (LocalStorage) ==========
const KEY='midterm_humanbody_M2_state_v1';
function saveState(){
  const state={
    name: byId('name').value, sid: byId('sid').value, room: byId('room').value,
    radios:{}, checks:{}, shorts:{}, dnd:{}, cats:{},
    selfK: byId('selfK').value, selfP: byId('selfP').value, selfA: byId('selfA').value, reflection: byId('reflection').value
  };
  QUIZ.items.forEach(q=>{
    if(q.type==='mcq'){
      const r = $$(`input[name="${q.id}"]:checked`)[0]; if(r) state.radios[q.id]=r.value;
    } else if(q.type==='ms'){
      const arr=[]; $$(`input[type=checkbox][data-id="${q.id}"]`).forEach((cb,i)=>{ if(cb.checked) arr.push(i); }); state.checks[q.id]=arr;
    } else if(q.type==='short'){
      const ta = $$(`textarea[data-id="${q.id}"]`)[0]; if(ta) state.shorts[q.id]=ta.value;
    } else if(q.type==='match'){
      const rows = $$(`.dropzone[data-id^="${q.id}__L"]`); state.dnd[q.id]=rows.map(r=>{ const tok=r.querySelector('.token'); return tok? tok.dataset.val:''; });
    } else if(q.type==='categorize'){
      const entry={}; Object.keys(q.cats).forEach(cat=>{ const box = $(`.dropzone[data-id="${q.id}"][data-cat="${cat}"]`); entry[cat]= $$('.token', box).map(t=>t.dataset.val); }); state.cats[q.id]=entry;
    }
  });
  localStorage.setItem(KEY, JSON.stringify(state));
}

function restoreState(){
  const raw = localStorage.getItem(KEY); if(!raw) return;
  try{
    const s = JSON.parse(raw);
    byId('name').value = s.name||''; byId('sid').value = s.sid||''; byId('room').value = s.room||'';
    QUIZ.items.forEach(q=>{
      if(q.type==='mcq'){
        const v = s.radios?.[q.id]; if(v!==undefined){ const r = $$(`input[name="${q.id}"][value="${v}"]`)[0]; if(r) r.checked=true; }
      } else if(q.type==='ms'){
        (s.checks?.[q.id]||[]).forEach(i=>{ const cb = $$(`input[type=checkbox][data-id="${q.id}"][value="${i}"]`)[0]; if(cb) cb.checked=true; });
      } else if(q.type==='short'){
        const ta = $$(`textarea[data-id="${q.id}"]`)[0]; if(ta) ta.value = s.shorts?.[q.id]||'';
      } else if(q.type==='match'){
        const rows = $$(`.dropzone[data-id^="${q.id}__L"]`); const vals = s.dnd?.[q.id]||[];
        rows.forEach((r,i)=>{ const expect = vals[i]; if(expect){ const token = $$(`.token[data-from="${q.id}"]`).find(t=>t.dataset.val===expect); if(token) r.appendChild(token); }});
      } else if(q.type==='categorize'){
        const entry = s.cats?.[q.id]||{}; Object.keys(entry).forEach(cat=>{ const box = $(`.dropzone[data-id="${q.id}"][data-cat="${cat}"]`); (entry[cat]||[]).forEach(val=>{ const token = $$(`.token[data-from="${q.id}"]`).find(t=>t.dataset.val===val); if(token) box.appendChild(token); }); });
      }
    });
    byId('selfK').value = s.selfK||''; byId('selfP').value = s.selfP||''; byId('selfA').value = s.selfA||''; byId('reflection').value = s.reflection||'';
  }catch(e){ console.warn('restore error', e); }
}

function resetAll(){ localStorage.removeItem(KEY); location.reload(); }

function updateProgress(){
  const totalInputs = $$('input[type=radio], input[type=checkbox], textarea').length + $$('.dropzone').length;
  let filled = $$('input[type=radio]:checked, input[type=checkbox]:checked').length;
  $$('textarea').forEach(t=>{ if(t.value.trim().length>0) filled++; });
  $$('.dropzone').forEach(d=>{ if(d.querySelector('.token')) filled++; });
  const pct = Math.min(100, Math.round(100*filled/Math.max(1,totalInputs)));
  byId('progbar').style.width = pct+'%';
}

// ========== Export ==========
function exportCSV(res){
  const name = byId('name').value||''; const sid = byId('sid').value||''; const room = byId('room').value||'';
  const selfK = byId('selfK').value||''; const selfP = byId('selfP').value||''; const selfA = byId('selfA').value||''; const reflection = byId('reflection').value||''; const ua = navigator.userAgent; const ts = new Date().toISOString();
  const headers = ['Timestamp','Name','StudentId','Room','UserAgent', ...QUIZ.items.map(q=>`${q.id}_resp`), ...QUIZ.items.map(q=>`${q.id}_pts`),'K_score','P_score','A_score','Total_score','SelfK','SelfP','SelfA','Reflection'];
  const row = [ts,name,sid,room,ua, ...res.answers.map(a=>a.resp), ...res.answers.map(a=>a.pts), res.sums.K,res.sums.P,res.sums.A,res.sums.total,selfK,selfP,selfA,reflection].map(escapeCsv).join(',');
  const csv = headers.join(',')+'\n'+row+'\n'; const fname = `Midterm_HumanBody_M2_${sid||'noid'}.csv`; download(fname, csv);
}
function exportJSON(res){
  const payload = { meta: QUIZ.meta, student: {name:byId('name').value||'', sid:byId('sid').value||'', room:byId('room').value||''}, sums: res.sums, answers: res.answers, self: {K:byId('selfK').value||'', P:byId('selfP').value||'', A:byId('selfA').value||'', reflection: byId('reflection').value||''}, ts: new Date().toISOString(), ua: navigator.userAgent };
  download(`Midterm_HumanBody_M2_${payload.student.sid||'noid'}.json`, JSON.stringify(payload,null,2));
}

// ========== Wire buttons ==========
byId('calcBtn').addEventListener('click',()=>{ const res = compute(); byId('sumK').textContent = res.sums.K.toFixed(2); byId('sumP').textContent = res.sums.P.toFixed(2); byId('sumA').textContent = res.sums.A.toFixed(2); byId('sumTotal').textContent = `${res.sums.total.toFixed(2)} / 100`; byId('exportCsvBtn').disabled=false; byId('exportJsonBtn').disabled=false; saveState(); });
byId('exportCsvBtn').addEventListener('click',()=>{ const res = compute(); exportCSV(res); });
byId('exportJsonBtn').addEventListener('click',()=>{ const res = compute(); exportJSON(res); });
byId('resetBtn').addEventListener('click',()=>{ if(confirm('ยืนยันล้างคำตอบทั้งหมด?')) resetAll(); });

render();
</script>
</body>
</html>
